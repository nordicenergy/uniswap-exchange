{"version":3,"file":"observe-rect.umd.development.js","sources":["../src/index.ts"],"sourcesContent":["let props: (keyof DOMRect)[] = [\n  'bottom',\n  'height',\n  'left',\n  'right',\n  'top',\n  'width'\n];\n\nlet rectChanged = (a: DOMRect = {} as DOMRect, b: DOMRect = {} as DOMRect) =>\n  props.some(prop => a[prop] !== b[prop]);\n\nlet observedNodes = new Map<HTMLElement, RectProps>();\nlet rafId: number;\n\nlet run = () => {\n  observedNodes.forEach(state => {\n    if (state.hasRectChanged) {\n      state.callbacks.forEach(cb => cb(state.rect));\n      state.hasRectChanged = false;\n    }\n  });\n\n  window.setTimeout(() => {\n    observedNodes.forEach((state, node) => {\n      let newRect = node.getBoundingClientRect();\n      if (rectChanged(newRect, state.rect)) {\n        state.hasRectChanged = true;\n        state.rect = newRect;\n      }\n    });\n  }, 0);\n\n  rafId = window.requestAnimationFrame(run);\n};\n\nexport default (node: HTMLElement, cb: Function) => {\n  return {\n    observe() {\n      let wasEmpty = observedNodes.size === 0;\n      if (observedNodes.has(node)) {\n        observedNodes.get(node)!.callbacks.push(cb);\n      } else {\n        observedNodes.set(node, {\n          rect: undefined,\n          hasRectChanged: false,\n          callbacks: [cb]\n        });\n      }\n      if (wasEmpty) run();\n    },\n\n    unobserve() {\n      let state = observedNodes.get(node);\n      if (state) {\n        // Remove the callback\n        const index = state.callbacks.indexOf(cb);\n        if (index >= 0) state.callbacks.splice(index, 1);\n\n        // Remove the node reference\n        if (!state.callbacks.length) observedNodes.delete(node);\n\n        // Stop the loop\n        if (!observedNodes.size) cancelAnimationFrame(rafId);\n      }\n    }\n  };\n};\n\nexport type PartialRect = Partial<DOMRect>;\n\nexport type RectProps = {\n  rect: DOMRect | undefined;\n  hasRectChanged: boolean;\n  callbacks: Function[];\n};\n"],"names":["props","rectChanged","a","b","some","prop","observedNodes","Map","rafId","run","forEach","state","hasRectChanged","callbacks","cb","rect","window","setTimeout","node","newRect","getBoundingClientRect","requestAnimationFrame","observe","wasEmpty","size","has","get","push","set","undefined","unobserve","index","indexOf","splice","length","cancelAnimationFrame"],"mappings":"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"}