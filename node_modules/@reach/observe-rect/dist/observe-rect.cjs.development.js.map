{"version":3,"file":"observe-rect.cjs.development.js","sources":["../src/index.ts"],"sourcesContent":["let props: (keyof DOMRect)[] = [\n  'bottom',\n  'height',\n  'left',\n  'right',\n  'top',\n  'width'\n];\n\nlet rectChanged = (a: DOMRect = {} as DOMRect, b: DOMRect = {} as DOMRect) =>\n  props.some(prop => a[prop] !== b[prop]);\n\nlet observedNodes = new Map<HTMLElement, RectProps>();\nlet rafId: number;\n\nlet run = () => {\n  observedNodes.forEach(state => {\n    if (state.hasRectChanged) {\n      state.callbacks.forEach(cb => cb(state.rect));\n      state.hasRectChanged = false;\n    }\n  });\n\n  window.setTimeout(() => {\n    observedNodes.forEach((state, node) => {\n      let newRect = node.getBoundingClientRect();\n      if (rectChanged(newRect, state.rect)) {\n        state.hasRectChanged = true;\n        state.rect = newRect;\n      }\n    });\n  }, 0);\n\n  rafId = window.requestAnimationFrame(run);\n};\n\nexport default (node: HTMLElement, cb: Function) => {\n  return {\n    observe() {\n      let wasEmpty = observedNodes.size === 0;\n      if (observedNodes.has(node)) {\n        observedNodes.get(node)!.callbacks.push(cb);\n      } else {\n        observedNodes.set(node, {\n          rect: undefined,\n          hasRectChanged: false,\n          callbacks: [cb]\n        });\n      }\n      if (wasEmpty) run();\n    },\n\n    unobserve() {\n      let state = observedNodes.get(node);\n      if (state) {\n        // Remove the callback\n        const index = state.callbacks.indexOf(cb);\n        if (index >= 0) state.callbacks.splice(index, 1);\n\n        // Remove the node reference\n        if (!state.callbacks.length) observedNodes.delete(node);\n\n        // Stop the loop\n        if (!observedNodes.size) cancelAnimationFrame(rafId);\n      }\n    }\n  };\n};\n\nexport type PartialRect = Partial<DOMRect>;\n\nexport type RectProps = {\n  rect: DOMRect | undefined;\n  hasRectChanged: boolean;\n  callbacks: Function[];\n};\n"],"names":["props","rectChanged","a","b","some","prop","observedNodes","Map","rafId","run","forEach","state","hasRectChanged","callbacks","cb","rect","window","setTimeout","node","newRect","getBoundingClientRect","requestAnimationFrame","observe","wasEmpty","size","has","get","push","set","undefined","unobserve","index","indexOf","splice","length","cancelAnimationFrame"],"mappings":";;;;AAAA,IAAIA,KAAK,GAAsB,CAC7B,QAD6B,EAE7B,QAF6B,EAG7B,MAH6B,EAI7B,OAJ6B,EAK7B,KAL6B,EAM7B,OAN6B,CAA/B;;AASA,IAAIC,WAAW,GAAG,SAAdA,WAAc,CAACC,CAAD,EAA6BC,CAA7B;AAAC,kBAAA,EAAA;AAAAD,IAAAA,IAAa,EAAb;;;AAA4B,kBAAA,EAAA;AAAAC,IAAAA,IAAa,EAAb;;;AAC7C,SAAAH,KAAK,CAACI,IAAN,CAAW,UAAAC,IAAA;AAAQ,WAAAH,CAAC,CAACG,IAAD,CAAD,KAAYF,CAAC,CAACE,IAAD,CAAb;AAAmB,GAAtC,CAAA;AAAuC,CADzC;;AAGA,IAAIC,aAAa;AAAA;AAAG,IAAIC,GAAJ,EAApB;AACA,IAAIC,KAAJ;;AAEA,IAAIC,GAAG,GAAG,SAANA,GAAM;AACRH,EAAAA,aAAa,CAACI,OAAd,CAAsB,UAAAC,KAAA;AACpB,QAAIA,KAAK,CAACC,cAAV,EAA0B;AACxBD,MAAAA,KAAK,CAACE,SAAN,CAAgBH,OAAhB,CAAwB,UAAAI,EAAA;AAAM,eAAAA,EAAE,CAACH,KAAK,CAACI,IAAP,CAAF;AAAc,OAA5C;AACAJ,MAAAA,KAAK,CAACC,cAAN,GAAuB,KAAvB;AACD;AACF,GALD;AAOAI,EAAAA,MAAM,CAACC,UAAP,CAAkB;AAChBX,IAAAA,aAAa,CAACI,OAAd,CAAsB,UAACC,KAAD,EAAQO,IAAR;AACpB,UAAIC,OAAO,GAAGD,IAAI,CAACE,qBAAL,EAAd;;AACA,UAAInB,WAAW,CAACkB,OAAD,EAAUR,KAAK,CAACI,IAAhB,CAAf,EAAsC;AACpCJ,QAAAA,KAAK,CAACC,cAAN,GAAuB,IAAvB;AACAD,QAAAA,KAAK,CAACI,IAAN,GAAaI,OAAb;AACD;AACF,KAND;AAOD,GARD,EAQG,CARH;AAUAX,EAAAA,KAAK,GAAGQ,MAAM,CAACK,qBAAP,CAA6BZ,GAA7B,CAAR;AACD,CAnBD;;AAqBA,aAAe,UAACS,IAAD,EAAoBJ,EAApB;AACb,SAAO;AACLQ,IAAAA,OAAO,EAAP;AACE,UAAIC,QAAQ,GAAGjB,aAAa,CAACkB,IAAd,KAAuB,CAAtC;;AACA,UAAIlB,aAAa,CAACmB,GAAd,CAAkBP,IAAlB,CAAJ,EAA6B;AAC3BZ,QAAAA,aAAa,CAACoB,GAAd,CAAkBR,IAAlB,EAAyBL,SAAzB,CAAmCc,IAAnC,CAAwCb,EAAxC;AACD,OAFD,MAEO;AACLR,QAAAA,aAAa,CAACsB,GAAd,CAAkBV,IAAlB,EAAwB;AACtBH,UAAAA,IAAI,EAAEc,SADgB;AAEtBjB,UAAAA,cAAc,EAAE,KAFM;AAGtBC,UAAAA,SAAS,EAAE,CAACC,EAAD;AAHW,SAAxB;AAKD;;AACD,UAAIS,QAAJ,EAAcd,GAAG;AAClB,KAbI;AAeLqB,IAAAA,SAAS;AACP,UAAInB,KAAK,GAAGL,aAAa,CAACoB,GAAd,CAAkBR,IAAlB,CAAZ;;AACA,UAAIP,KAAJ,EAAW;AACT;AACA,YAAMoB,KAAK,GAAGpB,KAAK,CAACE,SAAN,CAAgBmB,OAAhB,CAAwBlB,EAAxB,CAAd;AACA,YAAIiB,KAAK,IAAI,CAAb,EAAgBpB,KAAK,CAACE,SAAN,CAAgBoB,MAAhB,CAAuBF,KAAvB,EAA8B,CAA9B,EAHP;;AAMT,YAAI,CAACpB,KAAK,CAACE,SAAN,CAAgBqB,MAArB,EAA6B5B,aAAa,UAAb,CAAqBY,IAArB,EANpB;;AAST,YAAI,CAACZ,aAAa,CAACkB,IAAnB,EAAyBW,oBAAoB,CAAC3B,KAAD,CAApB;AAC1B;AACF;AA5BI,GAAP;AA8BD,CA/BD;;;;"}