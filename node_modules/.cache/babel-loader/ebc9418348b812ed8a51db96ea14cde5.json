{"ast":null,"code":"var _jsxFileName = \"/workspace/uniswap-exchange/src/pages/Pool/RemoveLiquidity.js\";\nimport React, { useState, useEffect, useCallback } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport ReactGA from \"react-ga\";\nimport { createBrowserHistory } from \"history\";\nimport { ethers } from \"ethers\";\nimport styled from \"styled-components\";\nimport { useWeb3React, useExchangeContract } from \"../../hooks\";\nimport { Button } from \"../../theme\";\nimport CurrencyInputPanel from \"../../components/CurrencyInputPanel\";\nimport ContextualInfo from \"../../components/ContextualInfo\";\nimport OversizedPanel from \"../../components/OversizedPanel\";\nimport ArrowDown from \"../../assets/svg/SVGArrowDown\";\nimport { useTransactionAdder } from \"../../contexts/Transactions\";\nimport { useTokenDetails } from \"../../contexts/Tokens\";\nimport { useAddressBalance, useETHPriceInUSD } from \"../../contexts/Balances\";\nimport { calculateGasMargin, amountFormatter } from \"../../utils\"; // denominated in bips\n\nconst ALLOWED_SLIPPAGE = ethers.utils.bigNumberify(200); // denominated in seconds\n\nconst DEADLINE_FROM_NOW = 60 * 15; // denominated in bips\n\nconst GAS_MARGIN = ethers.utils.bigNumberify(1000);\nconst BlueSpan = styled.span`\n  color: ${({\n  theme\n}) => theme.royalBlue};\n`;\nconst DownArrowBackground = styled.div`\n  ${({\n  theme\n}) => theme.flexRowNoWrap}\n  justify-content: center;\n  align-items: center;\n`;\nconst DownArrow = styled(ArrowDown)`\n  ${({\n  theme\n}) => theme.flexRowNoWrap}\n  color: ${({\n  theme,\n  active\n}) => active ? theme.royalBlue : theme.doveGray};\n  width: 0.625rem;\n  height: 0.625rem;\n  position: relative;\n  padding: 0.875rem;\n`;\nconst RemoveLiquidityOutput = styled.div`\n  ${({\n  theme\n}) => theme.flexRowNoWrap}\n  min-height: 3.5rem;\n`;\nconst RemoveLiquidityOutputText = styled.div`\n  font-size: 1.25rem;\n  line-height: 1.5rem;\n  padding: 1rem 0.75rem;\n`;\nconst RemoveLiquidityOutputPlus = styled.div`\n  font-size: 1.25rem;\n  line-height: 1.5rem;\n  padding: 1rem 0;\n`;\nconst SummaryPanel = styled.div`\n  ${({\n  theme\n}) => theme.flexColumnNoWrap}\n  padding: 1rem 0;\n`;\nconst LastSummaryText = styled.div`\n  margin-top: 1rem;\n`;\nconst ExchangeRateWrapper = styled.div`\n  ${({\n  theme\n}) => theme.flexRowNoWrap};\n  align-items: center;\n  color: ${({\n  theme\n}) => theme.doveGray};\n  font-size: 0.75rem;\n  padding: 0.25rem 1rem 0;\n`;\nconst ExchangeRate = styled.span`\n  flex: 1 1 auto;\n  width: 0;\n  color: ${({\n  theme\n}) => theme.doveGray};\n`;\nconst Flex = styled.div`\n  display: flex;\n  justify-content: center;\n  padding: 2rem;\n\n  button {\n    max-width: 20rem;\n  }\n`;\n\nfunction getExchangeRate(inputValue, inputDecimals, outputValue, outputDecimals, invert = false) {\n  try {\n    if (inputValue && (inputDecimals || inputDecimals === 0) && outputValue && (outputDecimals || outputDecimals === 0)) {\n      const factor = ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18));\n\n      if (invert) {\n        return inputValue.mul(factor).div(outputValue).mul(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(outputDecimals))).div(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(inputDecimals)));\n      } else {\n        return outputValue.mul(factor).div(inputValue).mul(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(inputDecimals))).div(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(outputDecimals)));\n      }\n    }\n  } catch {}\n}\n\nfunction getMarketRate(reserveETH, reserveToken, decimals, invert = false) {\n  return getExchangeRate(reserveETH, 18, reserveToken, decimals, invert);\n}\n\nfunction calculateSlippageBounds(value) {\n  if (value) {\n    const offset = value.mul(ALLOWED_SLIPPAGE).div(ethers.utils.bigNumberify(10000));\n    const minimum = value.sub(offset);\n    const maximum = value.add(offset);\n    return {\n      minimum: minimum.lt(ethers.constants.Zero) ? ethers.constants.Zero : minimum,\n      maximum: maximum.gt(ethers.constants.MaxUint256) ? ethers.constants.MaxUint256 : maximum\n    };\n  } else {\n    return {};\n  }\n}\n\nexport default function RemoveLiquidity({\n  params\n}) {\n  const {\n    t\n  } = useTranslation();\n  const {\n    library,\n    account,\n    active\n  } = useWeb3React();\n  const addTransaction = useTransactionAdder(); // clear url of query\n\n  useEffect(() => {\n    const history = createBrowserHistory();\n    history.push(window.location.pathname + \"\");\n  }, []);\n  const [outputCurrency, setOutputCurrency] = useState(params.poolTokenAddress);\n  const [value, setValue] = useState(params.poolTokenAmount ? params.poolTokenAmount : \"\");\n  const [inputError, setInputError] = useState();\n  const [valueParsed, setValueParsed] = useState(); // parse value\n\n  useEffect(() => {\n    try {\n      const parsedValue = ethers.utils.parseUnits(value, 18);\n      setValueParsed(parsedValue);\n    } catch {\n      if (value !== \"\") {\n        setInputError(t(\"inputNotValid\"));\n      }\n    }\n\n    return () => {\n      setInputError();\n      setValueParsed();\n    };\n  }, [t, value]);\n  const {\n    symbol,\n    decimals,\n    exchangeAddress\n  } = useTokenDetails(outputCurrency);\n  const [totalPoolTokens, setTotalPoolTokens] = useState();\n  const poolTokenBalance = useAddressBalance(account, exchangeAddress);\n  const exchangeETHBalance = useAddressBalance(exchangeAddress, \"ETH\");\n  const exchangeTokenBalance = useAddressBalance(exchangeAddress, outputCurrency); // input validation\n\n  useEffect(() => {\n    if (valueParsed && poolTokenBalance) {\n      if (valueParsed.gt(poolTokenBalance)) {\n        setInputError(t(\"insufficientBalance\"));\n      } else {\n        setInputError(null);\n      }\n    }\n  }, [poolTokenBalance, t, valueParsed]);\n  const exchange = useExchangeContract(exchangeAddress);\n  const ownershipPercentage = poolTokenBalance && totalPoolTokens && !totalPoolTokens.isZero() ? poolTokenBalance.mul(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18))).div(totalPoolTokens) : undefined;\n  const ownershipPercentageFormatted = ownershipPercentage && amountFormatter(ownershipPercentage, 16, 4);\n  const ETHOwnShare = exchangeETHBalance && ownershipPercentage && exchangeETHBalance.mul(ownershipPercentage).div(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18)));\n  const TokenOwnShare = exchangeTokenBalance && ownershipPercentage && exchangeTokenBalance.mul(ownershipPercentage).div(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18)));\n  const ETHPer = exchangeETHBalance && totalPoolTokens && !totalPoolTokens.isZero() ? exchangeETHBalance.mul(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18))).div(totalPoolTokens) : undefined;\n  const tokenPer = exchangeTokenBalance && totalPoolTokens && !totalPoolTokens.isZero() ? exchangeTokenBalance.mul(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18))).div(totalPoolTokens) : undefined;\n  const ethWithdrawn = ETHPer && valueParsed ? ETHPer.mul(valueParsed).div(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18))) : undefined;\n  const tokenWithdrawn = tokenPer && valueParsed ? tokenPer.mul(valueParsed).div(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18))) : undefined;\n  const ethWithdrawnMin = ethWithdrawn ? calculateSlippageBounds(ethWithdrawn).minimum : undefined;\n  const tokenWithdrawnMin = tokenWithdrawn ? calculateSlippageBounds(tokenWithdrawn).minimum : undefined;\n  const fetchPoolTokens = useCallback(() => {\n    if (exchange) {\n      exchange.totalSupply().then(totalSupply => {\n        setTotalPoolTokens(totalSupply);\n      });\n    }\n  }, [exchange]);\n  useEffect(() => {\n    fetchPoolTokens();\n    library.on(\"block\", fetchPoolTokens);\n    return () => {\n      library.removeListener(\"block\", fetchPoolTokens);\n    };\n  }, [fetchPoolTokens, library]); // BigNumber.js instance\n\n  const ethPrice = useETHPriceInUSD();\n\n  async function onRemoveLiquidity() {\n    // take ETH amount, multiplied by ETH rate and 2 for total tx size\n    let usdTransactionSize = ethPrice * (ethWithdrawn / 1e18) * 2;\n    ReactGA.event({\n      category: \"Transaction\",\n      action: \"Remove Liquidity\",\n      label: outputCurrency,\n      value: usdTransactionSize\n    });\n    const deadline = Math.ceil(Date.now() / 1000) + DEADLINE_FROM_NOW;\n    const estimatedGasLimit = await exchange.estimate.removeLiquidity(valueParsed, ethWithdrawnMin, tokenWithdrawnMin, deadline);\n    exchange.removeLiquidity(valueParsed, ethWithdrawnMin, tokenWithdrawnMin, deadline, {\n      gasLimit: calculateGasMargin(estimatedGasLimit, GAS_MARGIN)\n    }).then(response => {\n      addTransaction(response);\n    });\n  }\n\n  const b = text => React.createElement(BlueSpan, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 338\n    },\n    __self: this\n  }, text);\n\n  function renderTransactionDetails() {\n    return React.createElement(\"div\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 342\n      },\n      __self: this\n    }, React.createElement(\"div\", {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 343\n      },\n      __self: this\n    }, t(\"youAreRemoving\"), \" \", b(`${amountFormatter(ethWithdrawn, 18, 4)} ETH`), \" \", t(\"and\"), \" \", b(`${amountFormatter(tokenWithdrawn, decimals, Math.min(decimals, 4))} ${symbol}`), \" \", t(\"outPool\")), React.createElement(LastSummaryText, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 355\n      },\n      __self: this\n    }, t(\"youWillRemove\"), \" \", b(amountFormatter(valueParsed, 18, 4)), \" \", t(\"liquidityTokens\")), React.createElement(LastSummaryText, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 359\n      },\n      __self: this\n    }, t(\"totalSupplyIs\"), \" \", b(amountFormatter(totalPoolTokens, 18, 4))), React.createElement(LastSummaryText, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 362\n      },\n      __self: this\n    }, t(\"tokenWorth\"), \" \", b(amountFormatter(ETHPer, 18, 4)), \" ETH \", t(\"and\"), \" \", b(amountFormatter(tokenPer, decimals, Math.min(4, decimals))), \" \", symbol));\n  }\n\n  function renderSummary() {\n    let contextualInfo = \"\";\n    let isError = false;\n\n    if (inputError) {\n      contextualInfo = inputError;\n      isError = true;\n    } else if (!outputCurrency || outputCurrency === \"ETH\") {\n      contextualInfo = t(\"selectTokenCont\");\n    } else if (!valueParsed) {\n      contextualInfo = t(\"enterValueCont\");\n    } else if (!account) {\n      contextualInfo = t(\"noWallet\");\n      isError = true;\n    }\n\n    return React.createElement(ContextualInfo, {\n      key: \"context-info\",\n      openDetailsText: t(\"transactionDetails\"),\n      closeDetailsText: t(\"hideDetails\"),\n      contextualInfo: contextualInfo,\n      isError: isError,\n      renderTransactionDetails: renderTransactionDetails,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 388\n      },\n      __self: this\n    });\n  }\n\n  function formatBalance(value) {\n    return `Balance: ${value}`;\n  }\n\n  const isActive = active && account;\n  const isValid = inputError === null;\n  const marketRate = getMarketRate(exchangeETHBalance, exchangeTokenBalance, decimals);\n  return React.createElement(React.Fragment, null, React.createElement(CurrencyInputPanel, {\n    title: t(\"poolTokens\"),\n    extraText: poolTokenBalance && formatBalance(amountFormatter(poolTokenBalance, 18, 4)),\n    extraTextClickHander: () => {\n      if (poolTokenBalance) {\n        const valueToSet = poolTokenBalance;\n\n        if (valueToSet.gt(ethers.constants.Zero)) {\n          setValue(amountFormatter(valueToSet, 18, 18, false));\n        }\n      }\n    },\n    onCurrencySelected: setOutputCurrency,\n    onValueChange: setValue,\n    value: value,\n    errorMessage: inputError,\n    selectedTokenAddress: outputCurrency,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 414\n    },\n    __self: this\n  }), React.createElement(OversizedPanel, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 434\n    },\n    __self: this\n  }, React.createElement(DownArrowBackground, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 435\n    },\n    __self: this\n  }, React.createElement(DownArrow, {\n    active: isActive,\n    alt: \"arrow\",\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 436\n    },\n    __self: this\n  }))), React.createElement(CurrencyInputPanel, {\n    title: t(\"output\"),\n    description: !!(ethWithdrawn && tokenWithdrawn) ? `(${t(\"estimated\")})` : \"\",\n    key: \"remove-liquidity-input\",\n    renderInput: () => !!(ethWithdrawn && tokenWithdrawn) ? React.createElement(RemoveLiquidityOutput, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 447\n      },\n      __self: this\n    }, React.createElement(RemoveLiquidityOutputText, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 448\n      },\n      __self: this\n    }, `${amountFormatter(ethWithdrawn, 18, 4, false)} ETH`), React.createElement(RemoveLiquidityOutputPlus, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 451\n      },\n      __self: this\n    }, \" + \"), React.createElement(RemoveLiquidityOutputText, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 452\n      },\n      __self: this\n    }, `${amountFormatter(tokenWithdrawn, decimals, Math.min(4, decimals))} ${symbol}`)) : React.createElement(RemoveLiquidityOutput, {\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 461\n      },\n      __self: this\n    }),\n    disableTokenSelect: true,\n    disableUnlock: true,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 439\n    },\n    __self: this\n  }), React.createElement(OversizedPanel, {\n    key: \"remove-liquidity-input-under\",\n    hideBottom: true,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 467\n    },\n    __self: this\n  }, React.createElement(SummaryPanel, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 468\n    },\n    __self: this\n  }, React.createElement(ExchangeRateWrapper, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 469\n    },\n    __self: this\n  }, React.createElement(ExchangeRate, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 470\n    },\n    __self: this\n  }, t(\"exchangeRate\")), marketRate ? React.createElement(\"span\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 472\n    },\n    __self: this\n  }, `1 ETH = ${amountFormatter(marketRate, 18, 4)} ${symbol}`) : \" - \"), React.createElement(ExchangeRateWrapper, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 481\n    },\n    __self: this\n  }, React.createElement(ExchangeRate, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 482\n    },\n    __self: this\n  }, t(\"currentPoolSize\")), exchangeETHBalance && exchangeTokenBalance && (decimals || decimals === 0) ? React.createElement(\"span\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 486\n    },\n    __self: this\n  }, `${amountFormatter(exchangeETHBalance, 18, 4)} ETH + ${amountFormatter(exchangeTokenBalance, decimals, Math.min(decimals, 4))} ${symbol}`) : \" - \"), React.createElement(ExchangeRateWrapper, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 499\n    },\n    __self: this\n  }, React.createElement(ExchangeRate, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 500\n    },\n    __self: this\n  }, t(\"yourPoolShare\"), \" (\", ownershipPercentageFormatted && ownershipPercentageFormatted, \"%)\"), ETHOwnShare && TokenOwnShare ? React.createElement(\"span\", {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 505\n    },\n    __self: this\n  }, `${amountFormatter(ETHOwnShare, 18, 4)} ETH + ${amountFormatter(TokenOwnShare, decimals, Math.min(decimals, 4))} ${symbol}`) : \" - \"))), renderSummary(), React.createElement(Flex, {\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 523\n    },\n    __self: this\n  }, React.createElement(Button, {\n    disabled: !isValid,\n    onClick: onRemoveLiquidity,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 524\n    },\n    __self: this\n  }, t(\"removeLiquidity\"))));\n}","map":{"version":3,"sources":["/workspace/uniswap-exchange/src/pages/Pool/RemoveLiquidity.js"],"names":["React","useState","useEffect","useCallback","useTranslation","ReactGA","createBrowserHistory","ethers","styled","useWeb3React","useExchangeContract","Button","CurrencyInputPanel","ContextualInfo","OversizedPanel","ArrowDown","useTransactionAdder","useTokenDetails","useAddressBalance","useETHPriceInUSD","calculateGasMargin","amountFormatter","ALLOWED_SLIPPAGE","utils","bigNumberify","DEADLINE_FROM_NOW","GAS_MARGIN","BlueSpan","span","theme","royalBlue","DownArrowBackground","div","flexRowNoWrap","DownArrow","active","doveGray","RemoveLiquidityOutput","RemoveLiquidityOutputText","RemoveLiquidityOutputPlus","SummaryPanel","flexColumnNoWrap","LastSummaryText","ExchangeRateWrapper","ExchangeRate","Flex","getExchangeRate","inputValue","inputDecimals","outputValue","outputDecimals","invert","factor","pow","mul","getMarketRate","reserveETH","reserveToken","decimals","calculateSlippageBounds","value","offset","minimum","sub","maximum","add","lt","constants","Zero","gt","MaxUint256","RemoveLiquidity","params","t","library","account","addTransaction","history","push","window","location","pathname","outputCurrency","setOutputCurrency","poolTokenAddress","setValue","poolTokenAmount","inputError","setInputError","valueParsed","setValueParsed","parsedValue","parseUnits","symbol","exchangeAddress","totalPoolTokens","setTotalPoolTokens","poolTokenBalance","exchangeETHBalance","exchangeTokenBalance","exchange","ownershipPercentage","isZero","undefined","ownershipPercentageFormatted","ETHOwnShare","TokenOwnShare","ETHPer","tokenPer","ethWithdrawn","tokenWithdrawn","ethWithdrawnMin","tokenWithdrawnMin","fetchPoolTokens","totalSupply","then","on","removeListener","ethPrice","onRemoveLiquidity","usdTransactionSize","event","category","action","label","deadline","Math","ceil","Date","now","estimatedGasLimit","estimate","removeLiquidity","gasLimit","response","b","text","renderTransactionDetails","min","renderSummary","contextualInfo","isError","formatBalance","isActive","isValid","marketRate","valueToSet"],"mappings":";AAAA,OAAOA,KAAP,IAAgBC,QAAhB,EAA0BC,SAA1B,EAAqCC,WAArC,QAAwD,OAAxD;AACA,SAASC,cAAT,QAA+B,eAA/B;AACA,OAAOC,OAAP,MAAoB,UAApB;AACA,SAASC,oBAAT,QAAqC,SAArC;AACA,SAASC,MAAT,QAAuB,QAAvB;AACA,OAAOC,MAAP,MAAmB,mBAAnB;AAEA,SAASC,YAAT,EAAuBC,mBAAvB,QAAkD,aAAlD;AACA,SAASC,MAAT,QAAuB,aAAvB;AACA,OAAOC,kBAAP,MAA+B,qCAA/B;AACA,OAAOC,cAAP,MAA2B,iCAA3B;AACA,OAAOC,cAAP,MAA2B,iCAA3B;AACA,OAAOC,SAAP,MAAsB,+BAAtB;AACA,SAASC,mBAAT,QAAoC,6BAApC;AACA,SAASC,eAAT,QAAgC,uBAAhC;AACA,SAASC,iBAAT,EAA4BC,gBAA5B,QAAoD,yBAApD;AACA,SAASC,kBAAT,EAA6BC,eAA7B,QAAoD,aAApD,C,CAEA;;AACA,MAAMC,gBAAgB,GAAGf,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,GAA1B,CAAzB,C,CAEA;;AACA,MAAMC,iBAAiB,GAAG,KAAK,EAA/B,C,CAEA;;AACA,MAAMC,UAAU,GAAGnB,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,IAA1B,CAAnB;AAEA,MAAMG,QAAQ,GAAGnB,MAAM,CAACoB,IAAK;WAClB,CAAC;AAAEC,EAAAA;AAAF,CAAD,KAAeA,KAAK,CAACC,SAAU;CAD1C;AAIA,MAAMC,mBAAmB,GAAGvB,MAAM,CAACwB,GAAI;IACnC,CAAC;AAAEH,EAAAA;AAAF,CAAD,KAAeA,KAAK,CAACI,aAAc;;;CADvC;AAMA,MAAMC,SAAS,GAAG1B,MAAM,CAACO,SAAD,CAAY;IAChC,CAAC;AAAEc,EAAAA;AAAF,CAAD,KAAeA,KAAK,CAACI,aAAc;WAC5B,CAAC;AAAEJ,EAAAA,KAAF;AAASM,EAAAA;AAAT,CAAD,KAAwBA,MAAM,GAAGN,KAAK,CAACC,SAAT,GAAqBD,KAAK,CAACO,QAAU;;;;;CAF9E;AASA,MAAMC,qBAAqB,GAAG7B,MAAM,CAACwB,GAAI;IACrC,CAAC;AAAEH,EAAAA;AAAF,CAAD,KAAeA,KAAK,CAACI,aAAc;;CADvC;AAKA,MAAMK,yBAAyB,GAAG9B,MAAM,CAACwB,GAAI;;;;CAA7C;AAMA,MAAMO,yBAAyB,GAAG/B,MAAM,CAACwB,GAAI;;;;CAA7C;AAMA,MAAMQ,YAAY,GAAGhC,MAAM,CAACwB,GAAI;IAC5B,CAAC;AAAEH,EAAAA;AAAF,CAAD,KAAeA,KAAK,CAACY,gBAAiB;;CAD1C;AAKA,MAAMC,eAAe,GAAGlC,MAAM,CAACwB,GAAI;;CAAnC;AAIA,MAAMW,mBAAmB,GAAGnC,MAAM,CAACwB,GAAI;IACnC,CAAC;AAAEH,EAAAA;AAAF,CAAD,KAAeA,KAAK,CAACI,aAAc;;WAE5B,CAAC;AAAEJ,EAAAA;AAAF,CAAD,KAAeA,KAAK,CAACO,QAAS;;;CAHzC;AAQA,MAAMQ,YAAY,GAAGpC,MAAM,CAACoB,IAAK;;;WAGtB,CAAC;AAAEC,EAAAA;AAAF,CAAD,KAAeA,KAAK,CAACO,QAAS;CAHzC;AAMA,MAAMS,IAAI,GAAGrC,MAAM,CAACwB,GAAI;;;;;;;;CAAxB;;AAUA,SAASc,eAAT,CACEC,UADF,EAEEC,aAFF,EAGEC,WAHF,EAIEC,cAJF,EAKEC,MAAM,GAAG,KALX,EAME;AACA,MAAI;AACF,QACEJ,UAAU,KACTC,aAAa,IAAIA,aAAa,KAAK,CAD1B,CAAV,IAEAC,WAFA,KAGCC,cAAc,IAAIA,cAAc,KAAK,CAHtC,CADF,EAKE;AACA,YAAME,MAAM,GAAG7C,MAAM,CAACgB,KAAP,CACZC,YADY,CACC,EADD,EAEZ6B,GAFY,CAER9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,CAFQ,CAAf;;AAIA,UAAI2B,MAAJ,EAAY;AACV,eAAOJ,UAAU,CACdO,GADI,CACAF,MADA,EAEJpB,GAFI,CAEAiB,WAFA,EAGJK,GAHI,CAIH/C,MAAM,CAACgB,KAAP,CACGC,YADH,CACgB,EADhB,EAEG6B,GAFH,CAEO9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B0B,cAA1B,CAFP,CAJG,EAQJlB,GARI,CASHzB,MAAM,CAACgB,KAAP,CACGC,YADH,CACgB,EADhB,EAEG6B,GAFH,CAEO9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0BwB,aAA1B,CAFP,CATG,CAAP;AAaD,OAdD,MAcO;AACL,eAAOC,WAAW,CACfK,GADI,CACAF,MADA,EAEJpB,GAFI,CAEAe,UAFA,EAGJO,GAHI,CAIH/C,MAAM,CAACgB,KAAP,CACGC,YADH,CACgB,EADhB,EAEG6B,GAFH,CAEO9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0BwB,aAA1B,CAFP,CAJG,EAQJhB,GARI,CASHzB,MAAM,CAACgB,KAAP,CACGC,YADH,CACgB,EADhB,EAEG6B,GAFH,CAEO9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B0B,cAA1B,CAFP,CATG,CAAP;AAaD;AACF;AACF,GAzCD,CAyCE,MAAM,CAAE;AACX;;AAED,SAASK,aAAT,CAAuBC,UAAvB,EAAmCC,YAAnC,EAAiDC,QAAjD,EAA2DP,MAAM,GAAG,KAApE,EAA2E;AACzE,SAAOL,eAAe,CAACU,UAAD,EAAa,EAAb,EAAiBC,YAAjB,EAA+BC,QAA/B,EAAyCP,MAAzC,CAAtB;AACD;;AAED,SAASQ,uBAAT,CAAiCC,KAAjC,EAAwC;AACtC,MAAIA,KAAJ,EAAW;AACT,UAAMC,MAAM,GAAGD,KAAK,CACjBN,GADY,CACRhC,gBADQ,EAEZU,GAFY,CAERzB,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,KAA1B,CAFQ,CAAf;AAGA,UAAMsC,OAAO,GAAGF,KAAK,CAACG,GAAN,CAAUF,MAAV,CAAhB;AACA,UAAMG,OAAO,GAAGJ,KAAK,CAACK,GAAN,CAAUJ,MAAV,CAAhB;AACA,WAAO;AACLC,MAAAA,OAAO,EAAEA,OAAO,CAACI,EAAR,CAAW3D,MAAM,CAAC4D,SAAP,CAAiBC,IAA5B,IACL7D,MAAM,CAAC4D,SAAP,CAAiBC,IADZ,GAELN,OAHC;AAILE,MAAAA,OAAO,EAAEA,OAAO,CAACK,EAAR,CAAW9D,MAAM,CAAC4D,SAAP,CAAiBG,UAA5B,IACL/D,MAAM,CAAC4D,SAAP,CAAiBG,UADZ,GAELN;AANC,KAAP;AAQD,GAdD,MAcO;AACL,WAAO,EAAP;AACD;AACF;;AAED,eAAe,SAASO,eAAT,CAAyB;AAAEC,EAAAA;AAAF,CAAzB,EAAqC;AAClD,QAAM;AAAEC,IAAAA;AAAF,MAAQrE,cAAc,EAA5B;AACA,QAAM;AAAEsE,IAAAA,OAAF;AAAWC,IAAAA,OAAX;AAAoBxC,IAAAA;AAApB,MAA+B1B,YAAY,EAAjD;AAEA,QAAMmE,cAAc,GAAG5D,mBAAmB,EAA1C,CAJkD,CAMlD;;AACAd,EAAAA,SAAS,CAAC,MAAM;AACd,UAAM2E,OAAO,GAAGvE,oBAAoB,EAApC;AACAuE,IAAAA,OAAO,CAACC,IAAR,CAAaC,MAAM,CAACC,QAAP,CAAgBC,QAAhB,GAA2B,EAAxC;AACD,GAHQ,EAGN,EAHM,CAAT;AAKA,QAAM,CAACC,cAAD,EAAiBC,iBAAjB,IAAsClF,QAAQ,CAACuE,MAAM,CAACY,gBAAR,CAApD;AACA,QAAM,CAACxB,KAAD,EAAQyB,QAAR,IAAoBpF,QAAQ,CAChCuE,MAAM,CAACc,eAAP,GAAyBd,MAAM,CAACc,eAAhC,GAAkD,EADlB,CAAlC;AAGA,QAAM,CAACC,UAAD,EAAaC,aAAb,IAA8BvF,QAAQ,EAA5C;AACA,QAAM,CAACwF,WAAD,EAAcC,cAAd,IAAgCzF,QAAQ,EAA9C,CAjBkD,CAkBlD;;AACAC,EAAAA,SAAS,CAAC,MAAM;AACd,QAAI;AACF,YAAMyF,WAAW,GAAGpF,MAAM,CAACgB,KAAP,CAAaqE,UAAb,CAAwBhC,KAAxB,EAA+B,EAA/B,CAApB;AACA8B,MAAAA,cAAc,CAACC,WAAD,CAAd;AACD,KAHD,CAGE,MAAM;AACN,UAAI/B,KAAK,KAAK,EAAd,EAAkB;AAChB4B,QAAAA,aAAa,CAACf,CAAC,CAAC,eAAD,CAAF,CAAb;AACD;AACF;;AAED,WAAO,MAAM;AACXe,MAAAA,aAAa;AACbE,MAAAA,cAAc;AACf,KAHD;AAID,GAdQ,EAcN,CAACjB,CAAD,EAAIb,KAAJ,CAdM,CAAT;AAgBA,QAAM;AAAEiC,IAAAA,MAAF;AAAUnC,IAAAA,QAAV;AAAoBoC,IAAAA;AAApB,MAAwC7E,eAAe,CAACiE,cAAD,CAA7D;AAEA,QAAM,CAACa,eAAD,EAAkBC,kBAAlB,IAAwC/F,QAAQ,EAAtD;AACA,QAAMgG,gBAAgB,GAAG/E,iBAAiB,CAACyD,OAAD,EAAUmB,eAAV,CAA1C;AACA,QAAMI,kBAAkB,GAAGhF,iBAAiB,CAAC4E,eAAD,EAAkB,KAAlB,CAA5C;AACA,QAAMK,oBAAoB,GAAGjF,iBAAiB,CAC5C4E,eAD4C,EAE5CZ,cAF4C,CAA9C,CAxCkD,CA6ClD;;AACAhF,EAAAA,SAAS,CAAC,MAAM;AACd,QAAIuF,WAAW,IAAIQ,gBAAnB,EAAqC;AACnC,UAAIR,WAAW,CAACpB,EAAZ,CAAe4B,gBAAf,CAAJ,EAAsC;AACpCT,QAAAA,aAAa,CAACf,CAAC,CAAC,qBAAD,CAAF,CAAb;AACD,OAFD,MAEO;AACLe,QAAAA,aAAa,CAAC,IAAD,CAAb;AACD;AACF;AACF,GARQ,EAQN,CAACS,gBAAD,EAAmBxB,CAAnB,EAAsBgB,WAAtB,CARM,CAAT;AAUA,QAAMW,QAAQ,GAAG1F,mBAAmB,CAACoF,eAAD,CAApC;AAEA,QAAMO,mBAAmB,GACvBJ,gBAAgB,IAAIF,eAApB,IAAuC,CAACA,eAAe,CAACO,MAAhB,EAAxC,GACIL,gBAAgB,CACb3C,GADH,CACO/C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,EAA8B6B,GAA9B,CAAkC9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,CAAlC,CADP,EAEGQ,GAFH,CAEO+D,eAFP,CADJ,GAIIQ,SALN;AAMA,QAAMC,4BAA4B,GAChCH,mBAAmB,IAAIhF,eAAe,CAACgF,mBAAD,EAAsB,EAAtB,EAA0B,CAA1B,CADxC;AAGA,QAAMI,WAAW,GACfP,kBAAkB,IAClBG,mBADA,IAEAH,kBAAkB,CACf5C,GADH,CACO+C,mBADP,EAEGrE,GAFH,CAEOzB,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,EAA8B6B,GAA9B,CAAkC9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,CAAlC,CAFP,CAHF;AAMA,QAAMkF,aAAa,GACjBP,oBAAoB,IACpBE,mBADA,IAEAF,oBAAoB,CACjB7C,GADH,CACO+C,mBADP,EAEGrE,GAFH,CAEOzB,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,EAA8B6B,GAA9B,CAAkC9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,CAAlC,CAFP,CAHF;AAOA,QAAMmF,MAAM,GACVT,kBAAkB,IAAIH,eAAtB,IAAyC,CAACA,eAAe,CAACO,MAAhB,EAA1C,GACIJ,kBAAkB,CACf5C,GADH,CACO/C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,EAA8B6B,GAA9B,CAAkC9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,CAAlC,CADP,EAEGQ,GAFH,CAEO+D,eAFP,CADJ,GAIIQ,SALN;AAMA,QAAMK,QAAQ,GACZT,oBAAoB,IAAIJ,eAAxB,IAA2C,CAACA,eAAe,CAACO,MAAhB,EAA5C,GACIH,oBAAoB,CACjB7C,GADH,CACO/C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,EAA8B6B,GAA9B,CAAkC9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,CAAlC,CADP,EAEGQ,GAFH,CAEO+D,eAFP,CADJ,GAIIQ,SALN;AAOA,QAAMM,YAAY,GAChBF,MAAM,IAAIlB,WAAV,GACIkB,MAAM,CAACrD,GAAP,CAAWmC,WAAX,EAAwBzD,GAAxB,CACEzB,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,EAA8B6B,GAA9B,CAAkC9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,CAAlC,CADF,CADJ,GAII+E,SALN;AAMA,QAAMO,cAAc,GAClBF,QAAQ,IAAInB,WAAZ,GACImB,QAAQ,CACLtD,GADH,CACOmC,WADP,EAEGzD,GAFH,CAEOzB,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,EAA8B6B,GAA9B,CAAkC9C,MAAM,CAACgB,KAAP,CAAaC,YAAb,CAA0B,EAA1B,CAAlC,CAFP,CADJ,GAII+E,SALN;AAOA,QAAMQ,eAAe,GAAGF,YAAY,GAChClD,uBAAuB,CAACkD,YAAD,CAAvB,CAAsC/C,OADN,GAEhCyC,SAFJ;AAGA,QAAMS,iBAAiB,GAAGF,cAAc,GACpCnD,uBAAuB,CAACmD,cAAD,CAAvB,CAAwChD,OADJ,GAEpCyC,SAFJ;AAIA,QAAMU,eAAe,GAAG9G,WAAW,CAAC,MAAM;AACxC,QAAIiG,QAAJ,EAAc;AACZA,MAAAA,QAAQ,CAACc,WAAT,GAAuBC,IAAvB,CAA4BD,WAAW,IAAI;AACzClB,QAAAA,kBAAkB,CAACkB,WAAD,CAAlB;AACD,OAFD;AAGD;AACF,GANkC,EAMhC,CAACd,QAAD,CANgC,CAAnC;AAOAlG,EAAAA,SAAS,CAAC,MAAM;AACd+G,IAAAA,eAAe;AACfvC,IAAAA,OAAO,CAAC0C,EAAR,CAAW,OAAX,EAAoBH,eAApB;AAEA,WAAO,MAAM;AACXvC,MAAAA,OAAO,CAAC2C,cAAR,CAAuB,OAAvB,EAAgCJ,eAAhC;AACD,KAFD;AAGD,GAPQ,EAON,CAACA,eAAD,EAAkBvC,OAAlB,CAPM,CAAT,CAxHkD,CAiIlD;;AACA,QAAM4C,QAAQ,GAAGnG,gBAAgB,EAAjC;;AAEA,iBAAeoG,iBAAf,GAAmC;AACjC;AACA,QAAIC,kBAAkB,GAAGF,QAAQ,IAAIT,YAAY,GAAG,IAAnB,CAAR,GAAmC,CAA5D;AACAxG,IAAAA,OAAO,CAACoH,KAAR,CAAc;AACZC,MAAAA,QAAQ,EAAE,aADE;AAEZC,MAAAA,MAAM,EAAE,kBAFI;AAGZC,MAAAA,KAAK,EAAE1C,cAHK;AAIZtB,MAAAA,KAAK,EAAE4D;AAJK,KAAd;AAOA,UAAMK,QAAQ,GAAGC,IAAI,CAACC,IAAL,CAAUC,IAAI,CAACC,GAAL,KAAa,IAAvB,IAA+BxG,iBAAhD;AAEA,UAAMyG,iBAAiB,GAAG,MAAM9B,QAAQ,CAAC+B,QAAT,CAAkBC,eAAlB,CAC9B3C,WAD8B,EAE9BsB,eAF8B,EAG9BC,iBAH8B,EAI9Ba,QAJ8B,CAAhC;AAOAzB,IAAAA,QAAQ,CACLgC,eADH,CAEI3C,WAFJ,EAGIsB,eAHJ,EAIIC,iBAJJ,EAKIa,QALJ,EAMI;AACEQ,MAAAA,QAAQ,EAAEjH,kBAAkB,CAAC8G,iBAAD,EAAoBxG,UAApB;AAD9B,KANJ,EAUGyF,IAVH,CAUQmB,QAAQ,IAAI;AAChB1D,MAAAA,cAAc,CAAC0D,QAAD,CAAd;AACD,KAZH;AAaD;;AAED,QAAMC,CAAC,GAAGC,IAAI,IAAI,oBAAC,QAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAWA,IAAX,CAAlB;;AAEA,WAASC,wBAAT,GAAoC;AAClC,WACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACGhE,CAAC,CAAC,gBAAD,CADJ,EACwB,GADxB,EAEG8D,CAAC,CAAE,GAAElH,eAAe,CAACwF,YAAD,EAAe,EAAf,EAAmB,CAAnB,CAAsB,MAAzC,CAFJ,OAEsDpC,CAAC,CAAC,KAAD,CAFvD,EAEgE,GAFhE,EAGG8D,CAAC,CACC,GAAElH,eAAe,CAChByF,cADgB,EAEhBpD,QAFgB,EAGhBoE,IAAI,CAACY,GAAL,CAAShF,QAAT,EAAmB,CAAnB,CAHgB,CAIhB,IAAGmC,MAAO,EALZ,CAHJ,EASK,GATL,EAUGpB,CAAC,CAAC,SAAD,CAVJ,CADF,EAaE,oBAAC,eAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACGA,CAAC,CAAC,eAAD,CADJ,OACwB8D,CAAC,CAAClH,eAAe,CAACoE,WAAD,EAAc,EAAd,EAAkB,CAAlB,CAAhB,CADzB,EACgE,GADhE,EAEGhB,CAAC,CAAC,iBAAD,CAFJ,CAbF,EAiBE,oBAAC,eAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACGA,CAAC,CAAC,eAAD,CADJ,OACwB8D,CAAC,CAAClH,eAAe,CAAC0E,eAAD,EAAkB,EAAlB,EAAsB,CAAtB,CAAhB,CADzB,CAjBF,EAoBE,oBAAC,eAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACGtB,CAAC,CAAC,YAAD,CADJ,OACqB8D,CAAC,CAAClH,eAAe,CAACsF,MAAD,EAAS,EAAT,EAAa,CAAb,CAAhB,CADtB,WAC6DlC,CAAC,CAAC,KAAD,CAD9D,EACuE,GADvE,EAEG8D,CAAC,CAAClH,eAAe,CAACuF,QAAD,EAAWlD,QAAX,EAAqBoE,IAAI,CAACY,GAAL,CAAS,CAAT,EAAYhF,QAAZ,CAArB,CAAhB,CAFJ,EAEkE,GAFlE,EAGGmC,MAHH,CApBF,CADF;AA4BD;;AAED,WAAS8C,aAAT,GAAyB;AACvB,QAAIC,cAAc,GAAG,EAArB;AACA,QAAIC,OAAO,GAAG,KAAd;;AAEA,QAAItD,UAAJ,EAAgB;AACdqD,MAAAA,cAAc,GAAGrD,UAAjB;AACAsD,MAAAA,OAAO,GAAG,IAAV;AACD,KAHD,MAGO,IAAI,CAAC3D,cAAD,IAAmBA,cAAc,KAAK,KAA1C,EAAiD;AACtD0D,MAAAA,cAAc,GAAGnE,CAAC,CAAC,iBAAD,CAAlB;AACD,KAFM,MAEA,IAAI,CAACgB,WAAL,EAAkB;AACvBmD,MAAAA,cAAc,GAAGnE,CAAC,CAAC,gBAAD,CAAlB;AACD,KAFM,MAEA,IAAI,CAACE,OAAL,EAAc;AACnBiE,MAAAA,cAAc,GAAGnE,CAAC,CAAC,UAAD,CAAlB;AACAoE,MAAAA,OAAO,GAAG,IAAV;AACD;;AAED,WACE,oBAAC,cAAD;AACE,MAAA,GAAG,EAAC,cADN;AAEE,MAAA,eAAe,EAAEpE,CAAC,CAAC,oBAAD,CAFpB;AAGE,MAAA,gBAAgB,EAAEA,CAAC,CAAC,aAAD,CAHrB;AAIE,MAAA,cAAc,EAAEmE,cAJlB;AAKE,MAAA,OAAO,EAAEC,OALX;AAME,MAAA,wBAAwB,EAAEJ,wBAN5B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MADF;AAUD;;AAED,WAASK,aAAT,CAAuBlF,KAAvB,EAA8B;AAC5B,WAAQ,YAAWA,KAAM,EAAzB;AACD;;AAED,QAAMmF,QAAQ,GAAG5G,MAAM,IAAIwC,OAA3B;AACA,QAAMqE,OAAO,GAAGzD,UAAU,KAAK,IAA/B;AAEA,QAAM0D,UAAU,GAAG1F,aAAa,CAC9B2C,kBAD8B,EAE9BC,oBAF8B,EAG9BzC,QAH8B,CAAhC;AAMA,SACE,0CACE,oBAAC,kBAAD;AACE,IAAA,KAAK,EAAEe,CAAC,CAAC,YAAD,CADV;AAEE,IAAA,SAAS,EACPwB,gBAAgB,IAChB6C,aAAa,CAACzH,eAAe,CAAC4E,gBAAD,EAAmB,EAAnB,EAAuB,CAAvB,CAAhB,CAJjB;AAME,IAAA,oBAAoB,EAAE,MAAM;AAC1B,UAAIA,gBAAJ,EAAsB;AACpB,cAAMiD,UAAU,GAAGjD,gBAAnB;;AACA,YAAIiD,UAAU,CAAC7E,EAAX,CAAc9D,MAAM,CAAC4D,SAAP,CAAiBC,IAA/B,CAAJ,EAA0C;AACxCiB,UAAAA,QAAQ,CAAChE,eAAe,CAAC6H,UAAD,EAAa,EAAb,EAAiB,EAAjB,EAAqB,KAArB,CAAhB,CAAR;AACD;AACF;AACF,KAbH;AAcE,IAAA,kBAAkB,EAAE/D,iBAdtB;AAeE,IAAA,aAAa,EAAEE,QAfjB;AAgBE,IAAA,KAAK,EAAEzB,KAhBT;AAiBE,IAAA,YAAY,EAAE2B,UAjBhB;AAkBE,IAAA,oBAAoB,EAAEL,cAlBxB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IADF,EAqBE,oBAAC,cAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,oBAAC,mBAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,oBAAC,SAAD;AAAW,IAAA,MAAM,EAAE6D,QAAnB;AAA6B,IAAA,GAAG,EAAC,OAAjC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IADF,CADF,CArBF,EA0BE,oBAAC,kBAAD;AACE,IAAA,KAAK,EAAEtE,CAAC,CAAC,QAAD,CADV;AAEE,IAAA,WAAW,EACT,CAAC,EAAEoC,YAAY,IAAIC,cAAlB,CAAD,GAAsC,IAAGrC,CAAC,CAAC,WAAD,CAAc,GAAxD,GAA6D,EAHjE;AAKE,IAAA,GAAG,EAAC,wBALN;AAME,IAAA,WAAW,EAAE,MACX,CAAC,EAAEoC,YAAY,IAAIC,cAAlB,CAAD,GACE,oBAAC,qBAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACE,oBAAC,yBAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACI,GAAEzF,eAAe,CAACwF,YAAD,EAAe,EAAf,EAAmB,CAAnB,EAAsB,KAAtB,CAA6B,MADlD,CADF,EAIE,oBAAC,yBAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAJF,EAKE,oBAAC,yBAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OACI,GAAExF,eAAe,CACjByF,cADiB,EAEjBpD,QAFiB,EAGjBoE,IAAI,CAACY,GAAL,CAAS,CAAT,EAAYhF,QAAZ,CAHiB,CAIjB,IAAGmC,MAAO,EALd,CALF,CADF,GAeE,oBAAC,qBAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAtBN;AAyBE,IAAA,kBAAkB,MAzBpB;AA0BE,IAAA,aAAa,MA1Bf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IA1BF,EAsDE,oBAAC,cAAD;AAAgB,IAAA,GAAG,EAAC,8BAApB;AAAmD,IAAA,UAAU,MAA7D;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,oBAAC,YAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,oBAAC,mBAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,oBAAC,YAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAepB,CAAC,CAAC,cAAD,CAAhB,CADF,EAEGwE,UAAU,GACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAQ,WAAU5H,eAAe,CAC/B4H,UAD+B,EAE/B,EAF+B,EAG/B,CAH+B,CAI/B,IAAGpD,MAAO,EAJZ,CADS,GAOT,KATJ,CADF,EAaE,oBAAC,mBAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,oBAAC,YAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAepB,CAAC,CAAC,iBAAD,CAAhB,CADF,EAEGyB,kBAAkB,IACnBC,oBADC,KAEAzC,QAAQ,IAAIA,QAAQ,KAAK,CAFzB,IAGC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAQ,GAAErC,eAAe,CACvB6E,kBADuB,EAEvB,EAFuB,EAGvB,CAHuB,CAIvB,UAAS7E,eAAe,CACxB8E,oBADwB,EAExBzC,QAFwB,EAGxBoE,IAAI,CAACY,GAAL,CAAShF,QAAT,EAAmB,CAAnB,CAHwB,CAIxB,IAAGmC,MAAO,EARZ,CAHD,GAaC,KAfJ,CAbF,EA+BE,oBAAC,mBAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,oBAAC,YAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACGpB,CAAC,CAAC,eAAD,CADJ,QAEG+B,4BAA4B,IAAIA,4BAFnC,OADF,EAKGC,WAAW,IAAIC,aAAf,GACC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACI,GAAErF,eAAe,CACjBoF,WADiB,EAEjB,EAFiB,EAGjB,CAHiB,CAIjB,UAASpF,eAAe,CACxBqF,aADwB,EAExBhD,QAFwB,EAGxBoE,IAAI,CAACY,GAAL,CAAShF,QAAT,EAAmB,CAAnB,CAHwB,CAIxB,IAAGmC,MAAO,EATd,CADD,GAaC,KAlBJ,CA/BF,CADF,CAtDF,EA6GG8C,aAAa,EA7GhB,EA8GE,oBAAC,IAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACE,oBAAC,MAAD;AAAQ,IAAA,QAAQ,EAAE,CAACK,OAAnB;AAA4B,IAAA,OAAO,EAAEzB,iBAArC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KACG9C,CAAC,CAAC,iBAAD,CADJ,CADF,CA9GF,CADF;AAsHD","sourcesContent":["import React, { useState, useEffect, useCallback } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport ReactGA from \"react-ga\";\nimport { createBrowserHistory } from \"history\";\nimport { ethers } from \"ethers\";\nimport styled from \"styled-components\";\n\nimport { useWeb3React, useExchangeContract } from \"../../hooks\";\nimport { Button } from \"../../theme\";\nimport CurrencyInputPanel from \"../../components/CurrencyInputPanel\";\nimport ContextualInfo from \"../../components/ContextualInfo\";\nimport OversizedPanel from \"../../components/OversizedPanel\";\nimport ArrowDown from \"../../assets/svg/SVGArrowDown\";\nimport { useTransactionAdder } from \"../../contexts/Transactions\";\nimport { useTokenDetails } from \"../../contexts/Tokens\";\nimport { useAddressBalance, useETHPriceInUSD } from \"../../contexts/Balances\";\nimport { calculateGasMargin, amountFormatter } from \"../../utils\";\n\n// denominated in bips\nconst ALLOWED_SLIPPAGE = ethers.utils.bigNumberify(200);\n\n// denominated in seconds\nconst DEADLINE_FROM_NOW = 60 * 15;\n\n// denominated in bips\nconst GAS_MARGIN = ethers.utils.bigNumberify(1000);\n\nconst BlueSpan = styled.span`\n  color: ${({ theme }) => theme.royalBlue};\n`;\n\nconst DownArrowBackground = styled.div`\n  ${({ theme }) => theme.flexRowNoWrap}\n  justify-content: center;\n  align-items: center;\n`;\n\nconst DownArrow = styled(ArrowDown)`\n  ${({ theme }) => theme.flexRowNoWrap}\n  color: ${({ theme, active }) => (active ? theme.royalBlue : theme.doveGray)};\n  width: 0.625rem;\n  height: 0.625rem;\n  position: relative;\n  padding: 0.875rem;\n`;\n\nconst RemoveLiquidityOutput = styled.div`\n  ${({ theme }) => theme.flexRowNoWrap}\n  min-height: 3.5rem;\n`;\n\nconst RemoveLiquidityOutputText = styled.div`\n  font-size: 1.25rem;\n  line-height: 1.5rem;\n  padding: 1rem 0.75rem;\n`;\n\nconst RemoveLiquidityOutputPlus = styled.div`\n  font-size: 1.25rem;\n  line-height: 1.5rem;\n  padding: 1rem 0;\n`;\n\nconst SummaryPanel = styled.div`\n  ${({ theme }) => theme.flexColumnNoWrap}\n  padding: 1rem 0;\n`;\n\nconst LastSummaryText = styled.div`\n  margin-top: 1rem;\n`;\n\nconst ExchangeRateWrapper = styled.div`\n  ${({ theme }) => theme.flexRowNoWrap};\n  align-items: center;\n  color: ${({ theme }) => theme.doveGray};\n  font-size: 0.75rem;\n  padding: 0.25rem 1rem 0;\n`;\n\nconst ExchangeRate = styled.span`\n  flex: 1 1 auto;\n  width: 0;\n  color: ${({ theme }) => theme.doveGray};\n`;\n\nconst Flex = styled.div`\n  display: flex;\n  justify-content: center;\n  padding: 2rem;\n\n  button {\n    max-width: 20rem;\n  }\n`;\n\nfunction getExchangeRate(\n  inputValue,\n  inputDecimals,\n  outputValue,\n  outputDecimals,\n  invert = false\n) {\n  try {\n    if (\n      inputValue &&\n      (inputDecimals || inputDecimals === 0) &&\n      outputValue &&\n      (outputDecimals || outputDecimals === 0)\n    ) {\n      const factor = ethers.utils\n        .bigNumberify(10)\n        .pow(ethers.utils.bigNumberify(18));\n\n      if (invert) {\n        return inputValue\n          .mul(factor)\n          .div(outputValue)\n          .mul(\n            ethers.utils\n              .bigNumberify(10)\n              .pow(ethers.utils.bigNumberify(outputDecimals))\n          )\n          .div(\n            ethers.utils\n              .bigNumberify(10)\n              .pow(ethers.utils.bigNumberify(inputDecimals))\n          );\n      } else {\n        return outputValue\n          .mul(factor)\n          .div(inputValue)\n          .mul(\n            ethers.utils\n              .bigNumberify(10)\n              .pow(ethers.utils.bigNumberify(inputDecimals))\n          )\n          .div(\n            ethers.utils\n              .bigNumberify(10)\n              .pow(ethers.utils.bigNumberify(outputDecimals))\n          );\n      }\n    }\n  } catch {}\n}\n\nfunction getMarketRate(reserveETH, reserveToken, decimals, invert = false) {\n  return getExchangeRate(reserveETH, 18, reserveToken, decimals, invert);\n}\n\nfunction calculateSlippageBounds(value) {\n  if (value) {\n    const offset = value\n      .mul(ALLOWED_SLIPPAGE)\n      .div(ethers.utils.bigNumberify(10000));\n    const minimum = value.sub(offset);\n    const maximum = value.add(offset);\n    return {\n      minimum: minimum.lt(ethers.constants.Zero)\n        ? ethers.constants.Zero\n        : minimum,\n      maximum: maximum.gt(ethers.constants.MaxUint256)\n        ? ethers.constants.MaxUint256\n        : maximum\n    };\n  } else {\n    return {};\n  }\n}\n\nexport default function RemoveLiquidity({ params }) {\n  const { t } = useTranslation();\n  const { library, account, active } = useWeb3React();\n\n  const addTransaction = useTransactionAdder();\n\n  // clear url of query\n  useEffect(() => {\n    const history = createBrowserHistory();\n    history.push(window.location.pathname + \"\");\n  }, []);\n\n  const [outputCurrency, setOutputCurrency] = useState(params.poolTokenAddress);\n  const [value, setValue] = useState(\n    params.poolTokenAmount ? params.poolTokenAmount : \"\"\n  );\n  const [inputError, setInputError] = useState();\n  const [valueParsed, setValueParsed] = useState();\n  // parse value\n  useEffect(() => {\n    try {\n      const parsedValue = ethers.utils.parseUnits(value, 18);\n      setValueParsed(parsedValue);\n    } catch {\n      if (value !== \"\") {\n        setInputError(t(\"inputNotValid\"));\n      }\n    }\n\n    return () => {\n      setInputError();\n      setValueParsed();\n    };\n  }, [t, value]);\n\n  const { symbol, decimals, exchangeAddress } = useTokenDetails(outputCurrency);\n\n  const [totalPoolTokens, setTotalPoolTokens] = useState();\n  const poolTokenBalance = useAddressBalance(account, exchangeAddress);\n  const exchangeETHBalance = useAddressBalance(exchangeAddress, \"ETH\");\n  const exchangeTokenBalance = useAddressBalance(\n    exchangeAddress,\n    outputCurrency\n  );\n\n  // input validation\n  useEffect(() => {\n    if (valueParsed && poolTokenBalance) {\n      if (valueParsed.gt(poolTokenBalance)) {\n        setInputError(t(\"insufficientBalance\"));\n      } else {\n        setInputError(null);\n      }\n    }\n  }, [poolTokenBalance, t, valueParsed]);\n\n  const exchange = useExchangeContract(exchangeAddress);\n\n  const ownershipPercentage =\n    poolTokenBalance && totalPoolTokens && !totalPoolTokens.isZero()\n      ? poolTokenBalance\n          .mul(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18)))\n          .div(totalPoolTokens)\n      : undefined;\n  const ownershipPercentageFormatted =\n    ownershipPercentage && amountFormatter(ownershipPercentage, 16, 4);\n\n  const ETHOwnShare =\n    exchangeETHBalance &&\n    ownershipPercentage &&\n    exchangeETHBalance\n      .mul(ownershipPercentage)\n      .div(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18)));\n  const TokenOwnShare =\n    exchangeTokenBalance &&\n    ownershipPercentage &&\n    exchangeTokenBalance\n      .mul(ownershipPercentage)\n      .div(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18)));\n\n  const ETHPer =\n    exchangeETHBalance && totalPoolTokens && !totalPoolTokens.isZero()\n      ? exchangeETHBalance\n          .mul(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18)))\n          .div(totalPoolTokens)\n      : undefined;\n  const tokenPer =\n    exchangeTokenBalance && totalPoolTokens && !totalPoolTokens.isZero()\n      ? exchangeTokenBalance\n          .mul(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18)))\n          .div(totalPoolTokens)\n      : undefined;\n\n  const ethWithdrawn =\n    ETHPer && valueParsed\n      ? ETHPer.mul(valueParsed).div(\n          ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18))\n        )\n      : undefined;\n  const tokenWithdrawn =\n    tokenPer && valueParsed\n      ? tokenPer\n          .mul(valueParsed)\n          .div(ethers.utils.bigNumberify(10).pow(ethers.utils.bigNumberify(18)))\n      : undefined;\n\n  const ethWithdrawnMin = ethWithdrawn\n    ? calculateSlippageBounds(ethWithdrawn).minimum\n    : undefined;\n  const tokenWithdrawnMin = tokenWithdrawn\n    ? calculateSlippageBounds(tokenWithdrawn).minimum\n    : undefined;\n\n  const fetchPoolTokens = useCallback(() => {\n    if (exchange) {\n      exchange.totalSupply().then(totalSupply => {\n        setTotalPoolTokens(totalSupply);\n      });\n    }\n  }, [exchange]);\n  useEffect(() => {\n    fetchPoolTokens();\n    library.on(\"block\", fetchPoolTokens);\n\n    return () => {\n      library.removeListener(\"block\", fetchPoolTokens);\n    };\n  }, [fetchPoolTokens, library]);\n\n  // BigNumber.js instance\n  const ethPrice = useETHPriceInUSD();\n\n  async function onRemoveLiquidity() {\n    // take ETH amount, multiplied by ETH rate and 2 for total tx size\n    let usdTransactionSize = ethPrice * (ethWithdrawn / 1e18) * 2;\n    ReactGA.event({\n      category: \"Transaction\",\n      action: \"Remove Liquidity\",\n      label: outputCurrency,\n      value: usdTransactionSize\n    });\n\n    const deadline = Math.ceil(Date.now() / 1000) + DEADLINE_FROM_NOW;\n\n    const estimatedGasLimit = await exchange.estimate.removeLiquidity(\n      valueParsed,\n      ethWithdrawnMin,\n      tokenWithdrawnMin,\n      deadline\n    );\n\n    exchange\n      .removeLiquidity(\n        valueParsed,\n        ethWithdrawnMin,\n        tokenWithdrawnMin,\n        deadline,\n        {\n          gasLimit: calculateGasMargin(estimatedGasLimit, GAS_MARGIN)\n        }\n      )\n      .then(response => {\n        addTransaction(response);\n      });\n  }\n\n  const b = text => <BlueSpan>{text}</BlueSpan>;\n\n  function renderTransactionDetails() {\n    return (\n      <div>\n        <div>\n          {t(\"youAreRemoving\")}{\" \"}\n          {b(`${amountFormatter(ethWithdrawn, 18, 4)} ETH`)} {t(\"and\")}{\" \"}\n          {b(\n            `${amountFormatter(\n              tokenWithdrawn,\n              decimals,\n              Math.min(decimals, 4)\n            )} ${symbol}`\n          )}{\" \"}\n          {t(\"outPool\")}\n        </div>\n        <LastSummaryText>\n          {t(\"youWillRemove\")} {b(amountFormatter(valueParsed, 18, 4))}{\" \"}\n          {t(\"liquidityTokens\")}\n        </LastSummaryText>\n        <LastSummaryText>\n          {t(\"totalSupplyIs\")} {b(amountFormatter(totalPoolTokens, 18, 4))}\n        </LastSummaryText>\n        <LastSummaryText>\n          {t(\"tokenWorth\")} {b(amountFormatter(ETHPer, 18, 4))} ETH {t(\"and\")}{\" \"}\n          {b(amountFormatter(tokenPer, decimals, Math.min(4, decimals)))}{\" \"}\n          {symbol}\n        </LastSummaryText>\n      </div>\n    );\n  }\n\n  function renderSummary() {\n    let contextualInfo = \"\";\n    let isError = false;\n\n    if (inputError) {\n      contextualInfo = inputError;\n      isError = true;\n    } else if (!outputCurrency || outputCurrency === \"ETH\") {\n      contextualInfo = t(\"selectTokenCont\");\n    } else if (!valueParsed) {\n      contextualInfo = t(\"enterValueCont\");\n    } else if (!account) {\n      contextualInfo = t(\"noWallet\");\n      isError = true;\n    }\n\n    return (\n      <ContextualInfo\n        key=\"context-info\"\n        openDetailsText={t(\"transactionDetails\")}\n        closeDetailsText={t(\"hideDetails\")}\n        contextualInfo={contextualInfo}\n        isError={isError}\n        renderTransactionDetails={renderTransactionDetails}\n      />\n    );\n  }\n\n  function formatBalance(value) {\n    return `Balance: ${value}`;\n  }\n\n  const isActive = active && account;\n  const isValid = inputError === null;\n\n  const marketRate = getMarketRate(\n    exchangeETHBalance,\n    exchangeTokenBalance,\n    decimals\n  );\n\n  return (\n    <>\n      <CurrencyInputPanel\n        title={t(\"poolTokens\")}\n        extraText={\n          poolTokenBalance &&\n          formatBalance(amountFormatter(poolTokenBalance, 18, 4))\n        }\n        extraTextClickHander={() => {\n          if (poolTokenBalance) {\n            const valueToSet = poolTokenBalance;\n            if (valueToSet.gt(ethers.constants.Zero)) {\n              setValue(amountFormatter(valueToSet, 18, 18, false));\n            }\n          }\n        }}\n        onCurrencySelected={setOutputCurrency}\n        onValueChange={setValue}\n        value={value}\n        errorMessage={inputError}\n        selectedTokenAddress={outputCurrency}\n      />\n      <OversizedPanel>\n        <DownArrowBackground>\n          <DownArrow active={isActive} alt=\"arrow\" />\n        </DownArrowBackground>\n      </OversizedPanel>\n      <CurrencyInputPanel\n        title={t(\"output\")}\n        description={\n          !!(ethWithdrawn && tokenWithdrawn) ? `(${t(\"estimated\")})` : \"\"\n        }\n        key=\"remove-liquidity-input\"\n        renderInput={() =>\n          !!(ethWithdrawn && tokenWithdrawn) ? (\n            <RemoveLiquidityOutput>\n              <RemoveLiquidityOutputText>\n                {`${amountFormatter(ethWithdrawn, 18, 4, false)} ETH`}\n              </RemoveLiquidityOutputText>\n              <RemoveLiquidityOutputPlus> + </RemoveLiquidityOutputPlus>\n              <RemoveLiquidityOutputText>\n                {`${amountFormatter(\n                  tokenWithdrawn,\n                  decimals,\n                  Math.min(4, decimals)\n                )} ${symbol}`}\n              </RemoveLiquidityOutputText>\n            </RemoveLiquidityOutput>\n          ) : (\n            <RemoveLiquidityOutput />\n          )\n        }\n        disableTokenSelect\n        disableUnlock\n      />\n      <OversizedPanel key=\"remove-liquidity-input-under\" hideBottom>\n        <SummaryPanel>\n          <ExchangeRateWrapper>\n            <ExchangeRate>{t(\"exchangeRate\")}</ExchangeRate>\n            {marketRate ? (\n              <span>{`1 ETH = ${amountFormatter(\n                marketRate,\n                18,\n                4\n              )} ${symbol}`}</span>\n            ) : (\n              \" - \"\n            )}\n          </ExchangeRateWrapper>\n          <ExchangeRateWrapper>\n            <ExchangeRate>{t(\"currentPoolSize\")}</ExchangeRate>\n            {exchangeETHBalance &&\n            exchangeTokenBalance &&\n            (decimals || decimals === 0) ? (\n              <span>{`${amountFormatter(\n                exchangeETHBalance,\n                18,\n                4\n              )} ETH + ${amountFormatter(\n                exchangeTokenBalance,\n                decimals,\n                Math.min(decimals, 4)\n              )} ${symbol}`}</span>\n            ) : (\n              \" - \"\n            )}\n          </ExchangeRateWrapper>\n          <ExchangeRateWrapper>\n            <ExchangeRate>\n              {t(\"yourPoolShare\")} (\n              {ownershipPercentageFormatted && ownershipPercentageFormatted}%)\n            </ExchangeRate>\n            {ETHOwnShare && TokenOwnShare ? (\n              <span>\n                {`${amountFormatter(\n                  ETHOwnShare,\n                  18,\n                  4\n                )} ETH + ${amountFormatter(\n                  TokenOwnShare,\n                  decimals,\n                  Math.min(decimals, 4)\n                )} ${symbol}`}\n              </span>\n            ) : (\n              \" - \"\n            )}\n          </ExchangeRateWrapper>\n        </SummaryPanel>\n      </OversizedPanel>\n      {renderSummary()}\n      <Flex>\n        <Button disabled={!isValid} onClick={onRemoveLiquidity}>\n          {t(\"removeLiquidity\")}\n        </Button>\n      </Flex>\n    </>\n  );\n}\n"]},"metadata":{},"sourceType":"module"}