{"ast":null,"code":"\"use strict\"; // Copyright (c) 2018-2019 Coinbase, Inc. <https://coinbase.com/>\n// Licensed under the Apache License, version 2.0\n\nvar _classCallCheck = require(\"/workspace/uniswap-exchange/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/workspace/uniswap-exchange/node_modules/@babel/runtime/helpers/createClass\");\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) {\n    if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  }\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) {\n    if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\n  }\n  result[\"default\"] = mod;\n  return result;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar bind_decorator_1 = __importDefault(require(\"bind-decorator\"));\n\nvar crypto_1 = __importDefault(require(\"crypto\"));\n\nvar url_1 = __importDefault(require(\"url\"));\n\nvar ScopedLocalStorage_1 = require(\"./ScopedLocalStorage\");\n\nvar LinkedMessage_1 = require(\"./types/LinkedMessage\");\n\nvar LocalStorageBlockedMessage_1 = require(\"./types/LocalStorageBlockedMessage\");\n\nvar SessionIdRequestMessage_1 = require(\"./types/SessionIdRequestMessage\");\n\nvar SessionIdResponseMessage_1 = require(\"./types/SessionIdResponseMessage\");\n\nvar UnlinkedMessage_1 = require(\"./types/UnlinkedMessage\");\n\nvar Web3Method_1 = require(\"./types/Web3Method\");\n\nvar Web3RequestCanceledMessage_1 = require(\"./types/Web3RequestCanceledMessage\");\n\nvar Web3RequestMessage_1 = require(\"./types/Web3RequestMessage\");\n\nvar Web3Response_1 = require(\"./types/Web3Response\");\n\nvar Web3ResponseMessage_1 = require(\"./types/Web3ResponseMessage\");\n\nvar util_1 = require(\"./util\");\n\nvar walletLinkBlockedDialog = __importStar(require(\"./walletLinkBlockedDialog\"));\n\nvar WalletLinkNotification_1 = require(\"./WalletLinkNotification\");\n\nvar LOCAL_STORAGE_SESSION_ID_KEY = \"SessionId\";\nvar BLOCKED_LOCAL_STORAGE_ERROR_MESSAGE = \"Browser is blocking third-party localStorage usage. To continue, \" + \"turn off third-party storage blocking or whitelist WalletLink.\";\n\nvar WalletLinkRelay =\n/*#__PURE__*/\nfunction () {\n  function WalletLinkRelay(options) {\n    _classCallCheck(this, WalletLinkRelay);\n\n    this.iframeEl = null;\n    this.popupUrl = null;\n    this.popupWindow = null;\n    this.sessionId = null;\n    this.appName = \"\";\n    this.appLogoUrl = null;\n    this.linked = false;\n    this.iframeLoaded = false;\n    this.localStorageBlocked = false;\n    this.actionsPendingIframeLoad = [];\n    this.actionsPendingSessionId = [];\n    this.walletLinkUrl = options.walletLinkUrl;\n    var u = url_1.default.parse(this.walletLinkUrl);\n    this.walletLinkOrigin = \"\".concat(u.protocol, \"//\").concat(u.host);\n    this.storage = new ScopedLocalStorage_1.ScopedLocalStorage(\"__WalletLink__:\".concat(this.walletLinkOrigin));\n    this.sessionId = this.getStorageItem(LOCAL_STORAGE_SESSION_ID_KEY) || null;\n  }\n\n  _createClass(WalletLinkRelay, [{\n    key: \"setAppInfo\",\n    value: function setAppInfo(appName, appLogoUrl) {\n      this.appName = appName;\n      this.appLogoUrl = appLogoUrl;\n    }\n  }, {\n    key: \"injectIframe\",\n    value: function injectIframe() {\n      var _this = this;\n\n      if (this.iframeEl) {\n        throw new Error(\"iframe already injected!\");\n      }\n\n      var iframeEl = document.createElement(\"iframe\");\n      iframeEl.className = \"_WalletLinkBridge\";\n      iframeEl.width = \"1\";\n      iframeEl.height = \"1\";\n      iframeEl.style.opacity = \"0\";\n      iframeEl.style.pointerEvents = \"none\";\n      iframeEl.style.position = \"absolute\";\n      iframeEl.style.top = \"0\";\n      iframeEl.style.right = \"0\";\n      iframeEl.setAttribute(\"sandbox\", \"allow-scripts allow-popups allow-same-origin\");\n      iframeEl.src = \"\".concat(this.walletLinkUrl, \"/#/bridge\");\n      this.iframeEl = iframeEl;\n      window.addEventListener(\"message\", this.handleMessage, false);\n      window.addEventListener(\"beforeunload\", this.handleBeforeUnload, false);\n\n      var onIframeLoad = function onIframeLoad() {\n        _this.iframeLoaded = true;\n        iframeEl.removeEventListener(\"load\", onIframeLoad, false);\n\n        _this.postIPCMessage(SessionIdRequestMessage_1.SessionIdRequestMessage());\n\n        _this.actionsPendingIframeLoad.forEach(function (action) {\n          return action();\n        });\n\n        _this.actionsPendingIframeLoad = [];\n      };\n\n      iframeEl.addEventListener(\"load\", onIframeLoad, false);\n      document.documentElement.appendChild(iframeEl);\n    }\n  }, {\n    key: \"getStorageItem\",\n    value: function getStorageItem(key) {\n      return this.storage.getItem(key);\n    }\n  }, {\n    key: \"setStorageItem\",\n    value: function setStorageItem(key, value) {\n      this.storage.setItem(key, value);\n    }\n  }, {\n    key: \"requestEthereumAccounts\",\n    value: function requestEthereumAccounts() {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.requestEthereumAccounts,\n        params: {\n          appName: this.appName,\n          appLogoUrl: this.appLogoUrl || null\n        }\n      });\n    }\n  }, {\n    key: \"signEthereumMessage\",\n    value: function signEthereumMessage(message, address, addPrefix, typedDataJson) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.signEthereumMessage,\n        params: {\n          message: util_1.hexStringFromBuffer(message, true),\n          address: address,\n          addPrefix: addPrefix,\n          typedDataJson: typedDataJson || null\n        }\n      });\n    }\n  }, {\n    key: \"ethereumAddressFromSignedMessage\",\n    value: function ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.ethereumAddressFromSignedMessage,\n        params: {\n          message: util_1.hexStringFromBuffer(message, true),\n          signature: util_1.hexStringFromBuffer(signature, true),\n          addPrefix: addPrefix\n        }\n      });\n    }\n  }, {\n    key: \"signEthereumTransaction\",\n    value: function signEthereumTransaction(params) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.signEthereumTransaction,\n        params: {\n          fromAddress: params.fromAddress,\n          toAddress: params.toAddress,\n          weiValue: util_1.bigIntStringFromBN(params.weiValue),\n          data: util_1.hexStringFromBuffer(params.data, true),\n          nonce: params.nonce,\n          gasPriceInWei: params.gasPriceInWei ? util_1.bigIntStringFromBN(params.gasPriceInWei) : null,\n          gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n          chainId: params.chainId,\n          shouldSubmit: false\n        }\n      });\n    }\n  }, {\n    key: \"signAndSubmitEthereumTransaction\",\n    value: function signAndSubmitEthereumTransaction(params) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.signEthereumTransaction,\n        params: {\n          fromAddress: params.fromAddress,\n          toAddress: params.toAddress,\n          weiValue: util_1.bigIntStringFromBN(params.weiValue),\n          data: util_1.hexStringFromBuffer(params.data, true),\n          nonce: params.nonce,\n          gasPriceInWei: params.gasPriceInWei ? util_1.bigIntStringFromBN(params.gasPriceInWei) : null,\n          gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n          chainId: params.chainId,\n          shouldSubmit: true\n        }\n      });\n    }\n  }, {\n    key: \"submitEthereumTransaction\",\n    value: function submitEthereumTransaction(signedTransaction, chainId) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.submitEthereumTransaction,\n        params: {\n          signedTransaction: util_1.hexStringFromBuffer(signedTransaction, true),\n          chainId: chainId\n        }\n      });\n    }\n  }, {\n    key: \"scanQRCode\",\n    value: function scanQRCode(regExp) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.scanQRCode,\n        params: {\n          regExp: regExp\n        }\n      });\n    }\n  }, {\n    key: \"arbitraryRequest\",\n    value: function arbitraryRequest(data) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.arbitrary,\n        params: {\n          data: data\n        }\n      });\n    }\n  }, {\n    key: \"sendRequest\",\n    value: function sendRequest(request) {\n      var _this2 = this;\n\n      if (this.localStorageBlocked) {\n        walletLinkBlockedDialog.show();\n        return Promise.reject(new Error(BLOCKED_LOCAL_STORAGE_ERROR_MESSAGE));\n      }\n\n      return new Promise(function (resolve, reject) {\n        if (!_this2.iframeEl || !_this2.iframeEl.contentWindow) {\n          return reject(\"iframe is not initialized\");\n        }\n\n        var id = crypto_1.default.randomBytes(8).toString(\"hex\");\n\n        var cancel = function cancel() {\n          _this2.postIPCMessage(Web3RequestCanceledMessage_1.Web3RequestCanceledMessage(id));\n\n          _this2.invokeCallback(Web3ResponseMessage_1.Web3ResponseMessage({\n            id: id,\n            response: Web3Response_1.ErrorResponse(request.method, \"User rejected request\")\n          }));\n\n          if (notification) {\n            notification.hide();\n          }\n        };\n\n        var reset = function reset() {\n          _this2.openPopupWindow(\"/reset\");\n\n          if (notification) {\n            notification.hide();\n          }\n        };\n\n        var options = {\n          showProgressBar: true,\n          autoExpandAfter: 10000,\n          buttonInfo2: \"Made a mistake?\",\n          buttonLabel2: \"Cancel\",\n          onClickButton2: cancel\n        };\n        var isRequestAccounts = request.method === Web3Method_1.Web3Method.requestEthereumAccounts;\n\n        if (!_this2.linked && isRequestAccounts) {\n          var showPopup = function showPopup() {\n            _this2.openPopupWindow(\"/link?id=\".concat(_this2.sessionId));\n          };\n\n          showPopup();\n          options.message = \"Requesting to connect to your wallet...\";\n          options.buttonInfo1 = \"Don’t see the popup?\";\n          options.buttonLabel1 = \"Show window\";\n          options.onClickButton1 = showPopup;\n        } else {\n          options.message = \"Pushed a request to your wallet...\";\n          options.buttonInfo3 = \"Not receiving requests?\";\n          options.buttonLabel3 = \"Reconnect\";\n          options.onClickButton3 = reset;\n        }\n\n        if (isRequestAccounts) {\n          WalletLinkRelay.accountRequestCallbackIds.add(id);\n        }\n\n        WalletLinkRelay.callbacks.set(id, function (response) {\n          _this2.closePopupWindow();\n\n          if (notification) {\n            notification.hide();\n          }\n\n          if (response.errorMessage) {\n            return reject(new Error(response.errorMessage));\n          }\n\n          resolve(response);\n        });\n        var notification = new WalletLinkNotification_1.WalletLinkNotification(options);\n        notification.show();\n\n        _this2.postIPCMessage(Web3RequestMessage_1.Web3RequestMessage({\n          id: id,\n          request: request\n        }));\n      });\n    }\n  }, {\n    key: \"postIPCMessage\",\n    value: function postIPCMessage(message) {\n      var _this3 = this;\n\n      if (!this.iframeLoaded) {\n        this.actionsPendingIframeLoad.push(function () {\n          _this3.postIPCMessage(message);\n        });\n        return;\n      }\n\n      if (this.iframeEl && this.iframeEl.contentWindow) {\n        this.iframeEl.contentWindow.postMessage(message, this.walletLinkOrigin);\n      }\n    }\n  }, {\n    key: \"openPopupWindow\",\n    value: function openPopupWindow(path) {\n      var _this4 = this;\n\n      if (!this.sessionId) {\n        this.actionsPendingSessionId.push(function () {\n          _this4.openPopupWindow(path);\n        });\n        return;\n      }\n\n      var popupUrl = \"\".concat(this.walletLinkUrl, \"/#\").concat(path);\n\n      if (this.popupWindow && this.popupWindow.opener) {\n        if (this.popupUrl !== popupUrl) {\n          this.popupWindow.location.href = popupUrl;\n          this.popupUrl = popupUrl;\n        }\n\n        this.popupWindow.focus();\n        return;\n      }\n\n      var width = 320;\n      var height = 520;\n      var left = Math.floor(window.outerWidth / 2 - width / 2 + window.screenX);\n      var top = Math.floor(window.outerHeight / 2 - height / 2 + window.screenY);\n      this.popupUrl = popupUrl;\n      this.popupWindow = window.open(popupUrl, \"_blank\", [\"width=\".concat(width), \"height=\".concat(height), \"left=\".concat(left), \"top=\".concat(top), \"location=yes\", \"menubar=no\", \"resizable=no\", \"status=no\", \"titlebar=yes\", \"toolbar=no\"].join(\",\"));\n    }\n  }, {\n    key: \"closePopupWindow\",\n    value: function closePopupWindow() {\n      if (this.popupWindow) {\n        this.popupWindow.close();\n        this.popupUrl = null;\n        this.popupWindow = null;\n      }\n\n      window.focus();\n    }\n  }, {\n    key: \"invokeCallback\",\n    value: function invokeCallback(message) {\n      var callback = WalletLinkRelay.callbacks.get(message.id);\n\n      if (callback) {\n        callback(message.response);\n        WalletLinkRelay.callbacks.delete(message.id);\n      }\n    }\n  }, {\n    key: \"resetAndReload\",\n    value: function resetAndReload() {\n      this.storage.clear();\n      document.location.reload();\n    }\n  }, {\n    key: \"handleMessage\",\n    value: function handleMessage(evt) {\n      var _this5 = this;\n\n      if (evt.origin !== this.walletLinkOrigin) {\n        return;\n      }\n\n      var message = evt.data;\n\n      if (Web3ResponseMessage_1.isWeb3ResponseMessage(message)) {\n        var response = message.response;\n\n        if (Web3Response_1.isRequestEthereumAccountsResponse(response)) {\n          Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(function (id) {\n            return _this5.invokeCallback(Object.assign({}, message, {\n              id: id\n            }));\n          });\n          WalletLinkRelay.accountRequestCallbackIds.clear();\n          return;\n        }\n\n        this.invokeCallback(message);\n        return;\n      }\n\n      if (SessionIdResponseMessage_1.isSessionIdResponseMessage(message)) {\n        var sessionId = message.sessionId;\n\n        if (this.sessionId !== null && this.sessionId !== sessionId) {\n          // sessionId changed, clear all local data and reload page\n          this.resetAndReload();\n          return;\n        }\n\n        this.sessionId = sessionId;\n        this.setStorageItem(LOCAL_STORAGE_SESSION_ID_KEY, sessionId);\n        this.actionsPendingSessionId.forEach(function (action) {\n          return action();\n        });\n        this.actionsPendingSessionId = [];\n        return;\n      }\n\n      if (LinkedMessage_1.isLinkedMessage(message)) {\n        this.linked = true;\n        return;\n      }\n\n      if (UnlinkedMessage_1.isUnlinkedMessage(message)) {\n        this.linked = false;\n        this.resetAndReload();\n        return;\n      }\n\n      if (LocalStorageBlockedMessage_1.isLocalStorageBlockedMessage(message)) {\n        this.localStorageBlocked = true;\n\n        if (WalletLinkRelay.accountRequestCallbackIds.size > 0 && this.popupWindow) {\n          Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(function (id) {\n            return _this5.invokeCallback(Web3ResponseMessage_1.Web3ResponseMessage({\n              id: id,\n              response: Web3Response_1.ErrorResponse(Web3Method_1.Web3Method.requestEthereumAccounts, BLOCKED_LOCAL_STORAGE_ERROR_MESSAGE)\n            }));\n          });\n          WalletLinkRelay.accountRequestCallbackIds.clear();\n          walletLinkBlockedDialog.show();\n          this.closePopupWindow();\n        }\n\n        return;\n      }\n    }\n  }, {\n    key: \"handleBeforeUnload\",\n    value: function handleBeforeUnload(_evt) {\n      this.closePopupWindow();\n    }\n  }]);\n\n  return WalletLinkRelay;\n}();\n\nWalletLinkRelay.callbacks = new Map();\nWalletLinkRelay.accountRequestCallbackIds = new Set();\n\n__decorate([bind_decorator_1.default], WalletLinkRelay.prototype, \"handleMessage\", null);\n\n__decorate([bind_decorator_1.default], WalletLinkRelay.prototype, \"handleBeforeUnload\", null);\n\nexports.WalletLinkRelay = WalletLinkRelay;","map":{"version":3,"sources":["/workspace/uniswap-exchange/node_modules/walletlink/dist/WalletLinkRelay.js"],"names":["__decorate","decorators","target","key","desc","c","arguments","length","r","Object","getOwnPropertyDescriptor","d","Reflect","decorate","i","defineProperty","__importDefault","mod","__esModule","__importStar","result","k","hasOwnProperty","call","exports","value","bind_decorator_1","require","crypto_1","url_1","ScopedLocalStorage_1","LinkedMessage_1","LocalStorageBlockedMessage_1","SessionIdRequestMessage_1","SessionIdResponseMessage_1","UnlinkedMessage_1","Web3Method_1","Web3RequestCanceledMessage_1","Web3RequestMessage_1","Web3Response_1","Web3ResponseMessage_1","util_1","walletLinkBlockedDialog","WalletLinkNotification_1","LOCAL_STORAGE_SESSION_ID_KEY","BLOCKED_LOCAL_STORAGE_ERROR_MESSAGE","WalletLinkRelay","options","iframeEl","popupUrl","popupWindow","sessionId","appName","appLogoUrl","linked","iframeLoaded","localStorageBlocked","actionsPendingIframeLoad","actionsPendingSessionId","walletLinkUrl","u","default","parse","walletLinkOrigin","protocol","host","storage","ScopedLocalStorage","getStorageItem","Error","document","createElement","className","width","height","style","opacity","pointerEvents","position","top","right","setAttribute","src","window","addEventListener","handleMessage","handleBeforeUnload","onIframeLoad","removeEventListener","postIPCMessage","SessionIdRequestMessage","forEach","action","documentElement","appendChild","getItem","setItem","sendRequest","method","Web3Method","requestEthereumAccounts","params","message","address","addPrefix","typedDataJson","signEthereumMessage","hexStringFromBuffer","signature","ethereumAddressFromSignedMessage","signEthereumTransaction","fromAddress","toAddress","weiValue","bigIntStringFromBN","data","nonce","gasPriceInWei","gasLimit","chainId","shouldSubmit","signedTransaction","submitEthereumTransaction","regExp","scanQRCode","arbitrary","request","show","Promise","reject","resolve","contentWindow","id","randomBytes","toString","cancel","Web3RequestCanceledMessage","invokeCallback","Web3ResponseMessage","response","ErrorResponse","notification","hide","reset","openPopupWindow","showProgressBar","autoExpandAfter","buttonInfo2","buttonLabel2","onClickButton2","isRequestAccounts","showPopup","buttonInfo1","buttonLabel1","onClickButton1","buttonInfo3","buttonLabel3","onClickButton3","accountRequestCallbackIds","add","callbacks","set","closePopupWindow","errorMessage","WalletLinkNotification","Web3RequestMessage","push","postMessage","path","opener","location","href","focus","left","Math","floor","outerWidth","screenX","outerHeight","screenY","open","join","close","callback","get","delete","clear","reload","evt","origin","isWeb3ResponseMessage","isRequestEthereumAccountsResponse","Array","from","values","assign","isSessionIdResponseMessage","resetAndReload","setStorageItem","isLinkedMessage","isUnlinkedMessage","isLocalStorageBlockedMessage","size","_evt","Map","Set","prototype"],"mappings":"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","sourcesContent":["\"use strict\";\n// Copyright (c) 2018-2019 Coinbase, Inc. <https://coinbase.com/>\n// Licensed under the Apache License, version 2.0\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\n    result[\"default\"] = mod;\n    return result;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst bind_decorator_1 = __importDefault(require(\"bind-decorator\"));\nconst crypto_1 = __importDefault(require(\"crypto\"));\nconst url_1 = __importDefault(require(\"url\"));\nconst ScopedLocalStorage_1 = require(\"./ScopedLocalStorage\");\nconst LinkedMessage_1 = require(\"./types/LinkedMessage\");\nconst LocalStorageBlockedMessage_1 = require(\"./types/LocalStorageBlockedMessage\");\nconst SessionIdRequestMessage_1 = require(\"./types/SessionIdRequestMessage\");\nconst SessionIdResponseMessage_1 = require(\"./types/SessionIdResponseMessage\");\nconst UnlinkedMessage_1 = require(\"./types/UnlinkedMessage\");\nconst Web3Method_1 = require(\"./types/Web3Method\");\nconst Web3RequestCanceledMessage_1 = require(\"./types/Web3RequestCanceledMessage\");\nconst Web3RequestMessage_1 = require(\"./types/Web3RequestMessage\");\nconst Web3Response_1 = require(\"./types/Web3Response\");\nconst Web3ResponseMessage_1 = require(\"./types/Web3ResponseMessage\");\nconst util_1 = require(\"./util\");\nconst walletLinkBlockedDialog = __importStar(require(\"./walletLinkBlockedDialog\"));\nconst WalletLinkNotification_1 = require(\"./WalletLinkNotification\");\nconst LOCAL_STORAGE_SESSION_ID_KEY = \"SessionId\";\nconst BLOCKED_LOCAL_STORAGE_ERROR_MESSAGE = \"Browser is blocking third-party localStorage usage. To continue, \" +\n    \"turn off third-party storage blocking or whitelist WalletLink.\";\nclass WalletLinkRelay {\n    constructor(options) {\n        this.iframeEl = null;\n        this.popupUrl = null;\n        this.popupWindow = null;\n        this.sessionId = null;\n        this.appName = \"\";\n        this.appLogoUrl = null;\n        this.linked = false;\n        this.iframeLoaded = false;\n        this.localStorageBlocked = false;\n        this.actionsPendingIframeLoad = [];\n        this.actionsPendingSessionId = [];\n        this.walletLinkUrl = options.walletLinkUrl;\n        const u = url_1.default.parse(this.walletLinkUrl);\n        this.walletLinkOrigin = `${u.protocol}//${u.host}`;\n        this.storage = new ScopedLocalStorage_1.ScopedLocalStorage(`__WalletLink__:${this.walletLinkOrigin}`);\n        this.sessionId = this.getStorageItem(LOCAL_STORAGE_SESSION_ID_KEY) || null;\n    }\n    setAppInfo(appName, appLogoUrl) {\n        this.appName = appName;\n        this.appLogoUrl = appLogoUrl;\n    }\n    injectIframe() {\n        if (this.iframeEl) {\n            throw new Error(\"iframe already injected!\");\n        }\n        const iframeEl = document.createElement(\"iframe\");\n        iframeEl.className = \"_WalletLinkBridge\";\n        iframeEl.width = \"1\";\n        iframeEl.height = \"1\";\n        iframeEl.style.opacity = \"0\";\n        iframeEl.style.pointerEvents = \"none\";\n        iframeEl.style.position = \"absolute\";\n        iframeEl.style.top = \"0\";\n        iframeEl.style.right = \"0\";\n        iframeEl.setAttribute(\"sandbox\", \"allow-scripts allow-popups allow-same-origin\");\n        iframeEl.src = `${this.walletLinkUrl}/#/bridge`;\n        this.iframeEl = iframeEl;\n        window.addEventListener(\"message\", this.handleMessage, false);\n        window.addEventListener(\"beforeunload\", this.handleBeforeUnload, false);\n        const onIframeLoad = () => {\n            this.iframeLoaded = true;\n            iframeEl.removeEventListener(\"load\", onIframeLoad, false);\n            this.postIPCMessage(SessionIdRequestMessage_1.SessionIdRequestMessage());\n            this.actionsPendingIframeLoad.forEach(action => action());\n            this.actionsPendingIframeLoad = [];\n        };\n        iframeEl.addEventListener(\"load\", onIframeLoad, false);\n        document.documentElement.appendChild(iframeEl);\n    }\n    getStorageItem(key) {\n        return this.storage.getItem(key);\n    }\n    setStorageItem(key, value) {\n        this.storage.setItem(key, value);\n    }\n    requestEthereumAccounts() {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.requestEthereumAccounts,\n            params: {\n                appName: this.appName,\n                appLogoUrl: this.appLogoUrl || null\n            }\n        });\n    }\n    signEthereumMessage(message, address, addPrefix, typedDataJson) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumMessage,\n            params: {\n                message: util_1.hexStringFromBuffer(message, true),\n                address,\n                addPrefix,\n                typedDataJson: typedDataJson || null\n            }\n        });\n    }\n    ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.ethereumAddressFromSignedMessage,\n            params: {\n                message: util_1.hexStringFromBuffer(message, true),\n                signature: util_1.hexStringFromBuffer(signature, true),\n                addPrefix\n            }\n        });\n    }\n    signEthereumTransaction(params) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumTransaction,\n            params: {\n                fromAddress: params.fromAddress,\n                toAddress: params.toAddress,\n                weiValue: util_1.bigIntStringFromBN(params.weiValue),\n                data: util_1.hexStringFromBuffer(params.data, true),\n                nonce: params.nonce,\n                gasPriceInWei: params.gasPriceInWei\n                    ? util_1.bigIntStringFromBN(params.gasPriceInWei)\n                    : null,\n                gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n                chainId: params.chainId,\n                shouldSubmit: false\n            }\n        });\n    }\n    signAndSubmitEthereumTransaction(params) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumTransaction,\n            params: {\n                fromAddress: params.fromAddress,\n                toAddress: params.toAddress,\n                weiValue: util_1.bigIntStringFromBN(params.weiValue),\n                data: util_1.hexStringFromBuffer(params.data, true),\n                nonce: params.nonce,\n                gasPriceInWei: params.gasPriceInWei\n                    ? util_1.bigIntStringFromBN(params.gasPriceInWei)\n                    : null,\n                gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n                chainId: params.chainId,\n                shouldSubmit: true\n            }\n        });\n    }\n    submitEthereumTransaction(signedTransaction, chainId) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.submitEthereumTransaction,\n            params: {\n                signedTransaction: util_1.hexStringFromBuffer(signedTransaction, true),\n                chainId\n            }\n        });\n    }\n    scanQRCode(regExp) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.scanQRCode,\n            params: { regExp }\n        });\n    }\n    arbitraryRequest(data) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.arbitrary,\n            params: { data }\n        });\n    }\n    sendRequest(request) {\n        if (this.localStorageBlocked) {\n            walletLinkBlockedDialog.show();\n            return Promise.reject(new Error(BLOCKED_LOCAL_STORAGE_ERROR_MESSAGE));\n        }\n        return new Promise((resolve, reject) => {\n            if (!this.iframeEl || !this.iframeEl.contentWindow) {\n                return reject(\"iframe is not initialized\");\n            }\n            const id = crypto_1.default.randomBytes(8).toString(\"hex\");\n            const cancel = () => {\n                this.postIPCMessage(Web3RequestCanceledMessage_1.Web3RequestCanceledMessage(id));\n                this.invokeCallback(Web3ResponseMessage_1.Web3ResponseMessage({\n                    id,\n                    response: Web3Response_1.ErrorResponse(request.method, \"User rejected request\")\n                }));\n                if (notification) {\n                    notification.hide();\n                }\n            };\n            const reset = () => {\n                this.openPopupWindow(\"/reset\");\n                if (notification) {\n                    notification.hide();\n                }\n            };\n            const options = {\n                showProgressBar: true,\n                autoExpandAfter: 10000,\n                buttonInfo2: \"Made a mistake?\",\n                buttonLabel2: \"Cancel\",\n                onClickButton2: cancel\n            };\n            const isRequestAccounts = request.method === Web3Method_1.Web3Method.requestEthereumAccounts;\n            if (!this.linked && isRequestAccounts) {\n                const showPopup = () => {\n                    this.openPopupWindow(`/link?id=${this.sessionId}`);\n                };\n                showPopup();\n                options.message = \"Requesting to connect to your wallet...\";\n                options.buttonInfo1 = \"Don’t see the popup?\";\n                options.buttonLabel1 = \"Show window\";\n                options.onClickButton1 = showPopup;\n            }\n            else {\n                options.message = \"Pushed a request to your wallet...\";\n                options.buttonInfo3 = \"Not receiving requests?\";\n                options.buttonLabel3 = \"Reconnect\";\n                options.onClickButton3 = reset;\n            }\n            if (isRequestAccounts) {\n                WalletLinkRelay.accountRequestCallbackIds.add(id);\n            }\n            WalletLinkRelay.callbacks.set(id, response => {\n                this.closePopupWindow();\n                if (notification) {\n                    notification.hide();\n                }\n                if (response.errorMessage) {\n                    return reject(new Error(response.errorMessage));\n                }\n                resolve(response);\n            });\n            const notification = new WalletLinkNotification_1.WalletLinkNotification(options);\n            notification.show();\n            this.postIPCMessage(Web3RequestMessage_1.Web3RequestMessage({ id, request }));\n        });\n    }\n    postIPCMessage(message) {\n        if (!this.iframeLoaded) {\n            this.actionsPendingIframeLoad.push(() => {\n                this.postIPCMessage(message);\n            });\n            return;\n        }\n        if (this.iframeEl && this.iframeEl.contentWindow) {\n            this.iframeEl.contentWindow.postMessage(message, this.walletLinkOrigin);\n        }\n    }\n    openPopupWindow(path) {\n        if (!this.sessionId) {\n            this.actionsPendingSessionId.push(() => {\n                this.openPopupWindow(path);\n            });\n            return;\n        }\n        const popupUrl = `${this.walletLinkUrl}/#${path}`;\n        if (this.popupWindow && this.popupWindow.opener) {\n            if (this.popupUrl !== popupUrl) {\n                this.popupWindow.location.href = popupUrl;\n                this.popupUrl = popupUrl;\n            }\n            this.popupWindow.focus();\n            return;\n        }\n        const width = 320;\n        const height = 520;\n        const left = Math.floor(window.outerWidth / 2 - width / 2 + window.screenX);\n        const top = Math.floor(window.outerHeight / 2 - height / 2 + window.screenY);\n        this.popupUrl = popupUrl;\n        this.popupWindow = window.open(popupUrl, \"_blank\", [\n            `width=${width}`,\n            `height=${height}`,\n            `left=${left}`,\n            `top=${top}`,\n            \"location=yes\",\n            \"menubar=no\",\n            \"resizable=no\",\n            \"status=no\",\n            \"titlebar=yes\",\n            \"toolbar=no\"\n        ].join(\",\"));\n    }\n    closePopupWindow() {\n        if (this.popupWindow) {\n            this.popupWindow.close();\n            this.popupUrl = null;\n            this.popupWindow = null;\n        }\n        window.focus();\n    }\n    invokeCallback(message) {\n        const callback = WalletLinkRelay.callbacks.get(message.id);\n        if (callback) {\n            callback(message.response);\n            WalletLinkRelay.callbacks.delete(message.id);\n        }\n    }\n    resetAndReload() {\n        this.storage.clear();\n        document.location.reload();\n    }\n    handleMessage(evt) {\n        if (evt.origin !== this.walletLinkOrigin) {\n            return;\n        }\n        const message = evt.data;\n        if (Web3ResponseMessage_1.isWeb3ResponseMessage(message)) {\n            const { response } = message;\n            if (Web3Response_1.isRequestEthereumAccountsResponse(response)) {\n                Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => this.invokeCallback(Object.assign({}, message, { id })));\n                WalletLinkRelay.accountRequestCallbackIds.clear();\n                return;\n            }\n            this.invokeCallback(message);\n            return;\n        }\n        if (SessionIdResponseMessage_1.isSessionIdResponseMessage(message)) {\n            const { sessionId } = message;\n            if (this.sessionId !== null && this.sessionId !== sessionId) {\n                // sessionId changed, clear all local data and reload page\n                this.resetAndReload();\n                return;\n            }\n            this.sessionId = sessionId;\n            this.setStorageItem(LOCAL_STORAGE_SESSION_ID_KEY, sessionId);\n            this.actionsPendingSessionId.forEach(action => action());\n            this.actionsPendingSessionId = [];\n            return;\n        }\n        if (LinkedMessage_1.isLinkedMessage(message)) {\n            this.linked = true;\n            return;\n        }\n        if (UnlinkedMessage_1.isUnlinkedMessage(message)) {\n            this.linked = false;\n            this.resetAndReload();\n            return;\n        }\n        if (LocalStorageBlockedMessage_1.isLocalStorageBlockedMessage(message)) {\n            this.localStorageBlocked = true;\n            if (WalletLinkRelay.accountRequestCallbackIds.size > 0 &&\n                this.popupWindow) {\n                Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => this.invokeCallback(Web3ResponseMessage_1.Web3ResponseMessage({\n                    id,\n                    response: Web3Response_1.ErrorResponse(Web3Method_1.Web3Method.requestEthereumAccounts, BLOCKED_LOCAL_STORAGE_ERROR_MESSAGE)\n                })));\n                WalletLinkRelay.accountRequestCallbackIds.clear();\n                walletLinkBlockedDialog.show();\n                this.closePopupWindow();\n            }\n            return;\n        }\n    }\n    handleBeforeUnload(_evt) {\n        this.closePopupWindow();\n    }\n}\nWalletLinkRelay.callbacks = new Map();\nWalletLinkRelay.accountRequestCallbackIds = new Set();\n__decorate([\n    bind_decorator_1.default\n], WalletLinkRelay.prototype, \"handleMessage\", null);\n__decorate([\n    bind_decorator_1.default\n], WalletLinkRelay.prototype, \"handleBeforeUnload\", null);\nexports.WalletLinkRelay = WalletLinkRelay;\n"]},"metadata":{},"sourceType":"script"}